<?php

    $origem = "";
    $localizacao = "";
    $session = "";
    $dispositivo = "";
    if ($this->historicosnav->num_rows) {
        foreach ($this->historicosnav->rows as $row) {
            if ($row['pais'] != "" && $row['estado'] != "" && $row['cidade'] != "" && $localizacao == "") {
                $localizacao = $row['localizacao'];
            }
            if ($row['origem'] != "" && $origem == "") {
                $origem = $row['origem'];
            }
            if ($row['session'] != "" && $session == "") {
                $session = $row['session'];
            }
            if ($row['dispositivo'] == 1 && $dispositivo == "") {
                $dispositivo = "Desktop";
            } else if ($row['dispositivo'] == 2 && $dispositivo == "") {
                $dispositivo = "Tablet";
            } else if ($row['dispositivo'] == 3 && $dispositivo == "") {
                $dispositivo = "Mobile"; 
            } else if ($dispositivo == "") {
                $dispositivo = "Indefinido"; 
            }
        }
    }
    
    
    require_once "layouts/headers.phtml";
?>

    <link href="plugins/gallery/pretty-photo/prettyPhoto.css" type="text/css" rel="stylesheet" />

    <script type="text/javascript">
        var pagina = "<?php echo $this->getModule(); ?>";
        var permissao = "<?php echo $this->permissao_ref; ?>";
        var controller = "<?php echo $this->getModule(); ?>/save";
        var enviarProducao = "<?php echo $this->getModule(); ?>/producao";
        var criarMudarRemessa = "<?php echo $this->getModule(); ?>/criarMudarRemessa";
        var mudarRemessa = "<?php echo $this->getModule(); ?>/mudarRemessa";
        var retorno = "<?php echo $this->retorno; ?>";
    </script>
    
    <style>
        .nome {
            font-size: 14px;
            font-weight: bold;
        }
        .valor {
            font-size: 12px;
            font-weight: bold;
            color: #4e7a3a;
        }
        .valor span {
            text-decoration: line-through;
        }

        /* Observações inativas são riscadas e sem o botão de deletar */
        .obs-inativo {
            text-decoration: line-through;
        }
        .obs-inativo i {
            display: none;
        }
        /* Icones de ação das observações funcionam como botões */
        .obs-acoes i {
            cursor: pointer;
        }
    </style>
    </head>
    
    
    <body>
<?php  require_once "layouts/header.phtml"; ?>

        <!-- / #header -->
        <div id="wrapper">
        <!-- #wrapper -->

<?php  require_once "layouts/sidebar.phtml"; ?>
            
            <!--Body content-->
            <div id="content" class="page-content clearfix">
                <div class="contentwrapper">
                    <!--Content wrapper-->
                    <div class="heading">
                        <!--  .heading-->
                        <h3><?php echo $this->module_title; ?></h3>

                        <ul class="breadcrumb">
                            <li>Você está aqui:</li>
                            <li>
                                <a href="#" class="tip" title="Painel">
                                    <i class="s16 icomoon-icon-screen-2"></i>
                                </a>
                                <span class="divider">
                                    <i class="s16 icomoon-icon-arrow-right-3"></i>
                                </span>
                            </li>
                            <li>
                                <a class="tip" title="<?php echo $this->module_title; ?>" href="<?php echo $this->module_link;?>">
                                    <i class="s16 <?php echo $this->module_icon; ?>"></i>                                    
                                </a>
                            </li>
                            <span class="divider">
                                <i class="s16 icomoon-icon-arrow-right-3"></i>
                            </span>
                            <li class="active">Registro</li>
                        </ul>
                    </div>
                    <!-- End  / heading-->
                    <!-- Start .row -->

                        <?php if ($this->editor_permission): ?>
                        <?php else: ?>
                                <?php if (!isset($this->read)): ?>
                                    <div class="col-lg-10">
                                        <span class="label label-warning "><span class="icon24 typ-icon-warning"></span><?php echo $this->editor_name; ?> está editando este pedido, aguarde alguns minutos e recarregue a página para poder edita-la</span>
                                    </div>
                                    <br><br>
                                <?php endif ?>
                        <?php endif ?> 

                    <form name="order" enctype="multipart/form-data" method="post" class="form-horizontal group-border">
                        <input class="clickformsubmit" type="hidden" name="id" value="<?php echo $this->id; ?>" />
                        <input type="hidden" name="retorno" value="<?php echo $this->retorno; ?>">
                        <input type="hidden" name="codigo" value="<?php echo $this->registro['code']; ?>">
                        <input type="hidden" name="id_status_original" value="<?php echo $this->registro['id_status']; ?>">
                        <input type="hidden" name="id_vendedor_atual" value="<?php echo $this->registro['id_vendedor']; ?>">
                        <input type="hidden" name="agendor" value="<?php echo $this->registro['agendor']; ?>">
                        <input type="hidden" name="id_cliente" value="<?php echo $this->registro['id_cliente']; ?>">
                        
                        <?php if ($this->ordens_producao->num_rows): ?>
                            <div class="row">
                                <div class="col-lg-12">
                                    <div class="production_info">
                                        Pedido em produção: <?= $this->data_producao; ?>

                                        <div>
                                            <?php foreach ($this->ordens_producao->rows as $key => $ordem): ?>
                                                <div class="item">
                                                    <h5><?= $ordem['nome_produto'] ?></h5>
                                                    <div>
                                                        <div>
                                                            <?php if($ordem['agrupavel']): ?>
                                                            <p>Quantidade: <?= $ordem['quantidade'] ?></p>
                                                            <?php endif; ?>
                                                            <p>Status: <?= $ordem['titulo_status'] ?></p>
                                                            <p>Remessa: <?= $ordem['titulo_remessa'] ?></p>
                                                        </div>
                                                        <button type="button" class="btn btn-warning mudar_remessa" data-remessa="<?= $ordem['id_remessa'] ?>" data-id="<?= $ordem['id'] ?>">Mudar remessa</button>
                                                    </div>
                                                </div>
                                            <?php endforeach; ?>
                                        </div>
                                    </div>
                                </div>

                                <!-- REMESSAS -->
                                <div class="col-lg-12">
                                    <?php foreach($this->remessasDessePedido as $remessa): ?>
                                    <!-- Start .panel -->
                                    <div class="panel panel-default toggle" style="margin-bottom: 10px;">
                                        <div class="panel-heading min">
                                            <h4 class="panel-title">Remessa #<?= $remessa['titulo'] ?></h4>
                                        </div>
                                        <!-- Start .panel-body -->
                                        <div class="panel-body" style="display: none;">
                                            <div class="form-group">
                                                <label class="col-lg-2 control-label" for="data_entrega">Entrega:</label>
                                                <div class="col-lg-2">
                                                    <input disabled class="form-control" name="data_entrega" type="text" value="<?= $remessa['entrega_formatada'] ?>" />
                                                </div>

                                                <label class="col-lg-1 control-label" for="data_saida">Saída:</label>
                                                <div class="col-lg-2">
                                                    <input disabled class="form-control" name="data_saida" type="text" value="<?= $remessa['saida_formatada'] ?>" />
                                                </div>

                                                <label class="col-lg-1 control-label" for="nome">Nota:</label>
                                                <div class="col-lg-4">
                                                    <input disabled class="form-control" type="text" value="<?= $remessa['n_nota'] ?>" />
                                                </div>
                                            </div>

                                            <div class="form-group">
                                                <label class="col-lg-2 control-label" for="nome">Cliente:</label>
                                                <div class="col-lg-10">
                                                    <input disabled class="form-control" type="text" value="<?= $remessa['nome'] ?>" />
                                                </div>
                                            </div><!-- End .form-group  -->

                                            <div class="form-group">
                                                <label class="col-lg-2 control-label" for="nome">Telefone:</label>
                                                <div class="col-lg-5">
                                                    <input disabled class="form-control" type="text" value="<?= $remessa['telefone'] ?>" />
                                                </div>

                                                <label class="col-lg-1 control-label" for="nome">CPF / CNPJ:</label>
                                                <div class="col-lg-4">
                                                    <input disabled class="form-control" type="text" value="<?= $remessa['cpf_cnpj'] ?>" />
                                                </div>
                                            </div><!-- End .form-group  -->

                                            <div class="form-group">
                                                <label class="col-lg-2 control-label" for="nome">CEP:</label>
                                                <div class="col-lg-10">
                                                    <input disabled class="form-control" type="text" value="<?= $remessa['cep'] ?>" />
                                                </div>
                                            </div><!-- End .form-group  -->

                                            <div class="form-group">
                                                <label class="col-lg-2 control-label" for="nome">Endereço:</label>
                                                <div class="col-lg-5">
                                                    <input disabled class="form-control" type="text" value="<?= $remessa['endereco'] ?>" />
                                                </div>

                                                <label class="col-lg-1 control-label" for="nome">Número:</label>
                                                <div class="col-lg-4">
                                                    <input disabled class="form-control" type="text" value="<?= $remessa['numero'] ?>" />
                                                </div>
                                            </div><!-- End .form-group  -->

                                            <div class="form-group">
                                                <label class="col-lg-2 control-label" for="nome">Complemento:</label>
                                                <div class="col-lg-10">
                                                    <input disabled class="form-control" type="text" value="<?= $remessa['complemento'] ?>" />
                                                </div>
                                            </div><!-- End .form-group  -->

                                            <div class="form-group">
                                                <label class="col-lg-2 control-label" for="nome">Estado:</label>
                                                <div class="col-lg-2">
                                                    <input disabled class="form-control" type="text" value="<?= $remessa['estado'] ?>" />
                                                </div>

                                                <label class="col-lg-1 control-label" for="nome">Cidade:</label>
                                                <div class="col-lg-2">
                                                    <input disabled class="form-control" type="text" value="<?= $remessa['cidade'] ?>" />
                                                </div>

                                                <label class="col-lg-1 control-label" for="nome">Bairro:</label>
                                                <div class="col-lg-4">
                                                    <input disabled class="form-control" type="text" value="<?= $remessa['bairro'] ?>" />
                                                </div>
                                            </div><!-- End .form-group  -->

                                            <div class="form-group">
                                                <label class="col-lg-2 control-label" for="nome">Produtos:</label>
                                                <div class="col-lg-10 pedido_ordem">
                                                    <?php $ordensFiltradas = array_filter($remessa['ordens'], function($ordem) {
                                                        return $ordem['id_pedido'] == $this->id; });
                                                    foreach($ordensFiltradas as $ordem): ?>
                                                        <a><?= $ordem['nome_produto']; ?></a>
                                                    <?php endforeach; ?>
                                                </div>
                                            </div><!-- End .form-group  -->

                                            <div class="form-group">
                                                <label class="col-lg-2 control-label" for="nome">Outros pedidos:</label>
                                                <div class="col-lg-10 pedido_ordem">
                                                    <?php $ordensFiltradas = array_filter($remessa['ordens'], function($ordem) {
                                                        return $ordem['id_pedido'] != $this->id;});
                                                    foreach($ordensFiltradas as $ordem): ?>
                                                        <a href="order/edit/id/<?= $ordem['id_pedido'] ?>"><?= $ordem['id_pedido'] ?> - <?= $ordem['nome_produto']; ?></a>
                                                    <?php endforeach; ?>
                                                </div>
                                            </div><!-- End .form-group  -->
                                        </div>
                                        <!-- End .panel-body -->
                                    </div>
                                    <!-- End .panel -->
                                    <?php endforeach; ?>
                                </div>
                            </div>
                        <?php endif; ?>

                        <div class="row">
                            <div class="col-lg-12">
                                <div class="panel panel-default toggle">
                                    <!-- Start .panel -->
                                    <div class="panel-heading">
                                        <h4 class="panel-title">Dados do Pedido</h4>
                                    </div>
                                    <div class="panel-body">
                                        <div class="form-group">
                                            <label class="col-lg-2 control-label" for="id">Nº do Pedido:</label>
                                            <div class="col-lg-2">
                                                <input readonly class="form-control" name="id" id="id" type="text" value="<?php echo $this->registro['id'] ?>" />
                                                <a href="<?php echo $this->site_url."/orcamento/".strtoupper(dechex($this->registro['code'])) ?>" target="_blank">[ orçamento ]</a>
                                            </div><!-- End .form-group  -->
                                            <label class="col-lg-2 control-label" for="data_compra">Data da Compra:</label>
                                            <div class="col-lg-2">
                                                <input readonly class="form-control" name="data_compra" id="data_compra" type="text" value="<?php echo $this->registro['data_compra'] ?>" />
                                            </div><!-- End .form-group  -->
                                            <label class="col-lg-2 control-label" for="data_competencia">Data da Competência:</label>
                                            <div class="col-lg-2">
                                                <input <?php if ($_SESSION['admin_grupo'] != 2): ?> readonly <?php endif ?>class="form-control" name="data_competencia" id="data_competencia" type="text" value="<?php echo $this->registro['data_competencia'] ?>" />
                                            </div><!-- End .form-group  -->
                                        </div>
                                                                            
                                        <div class="form-group">
                                            <?php $primeiro_nome = explode(" ",$this->registro['cliente']); $primeiro_nome = $primeiro_nome[0] ?>
                                            <label class="col-lg-2 control-label" for="cliente">Cliente: <a href="https://web.whatsapp.com/send?phone=55<?php echo str_replace(" ","",str_replace(")","",str_replace("(","",$this->registro['cliente_telefone']))); ?>&text=Ol%C3%A1%20<?php echo $primeiro_nome; ?>,%20estou%20entrando%20em%20contato%20para%20falar%20do%20seu%20pedido%20<?php echo $this->id; ?>%20na%20Real%20Poker" target="_blank"><img src="../img/icon_televendas_whatsapp.png" alt="Entre em contato" style="width:25px; margin: 0 -20px 0 0;"></a></label>
                                            <div class="col-lg-6">
                                                <?php 
                                                    $empresa = ''; 
                                                    if($this->registro['pessoa']==2) $empresa = ' ('.$this->registro['razao_social'].')'; 
                                                ?>
                                                <a class="tip" title="Ir Para o Cliente" href="client/edit/id/<?php echo $this->registro['id_cliente'];?>" target="_blank"><input readonly class="form-control pointer" name="cliente" id="cliente" type="text" value="<?php echo $this->registro['cliente'].$empresa ?>" /></a>
                                            </div><!-- End .form-group  -->
                                            <label class="col-lg-2 control-label" for="tipo_cliente">Tipo:</label>
                                            <div class="col-lg-2">
                                                <select name="tipo_cliente" class="tipo_cliente" <?php if(!$this->editor_permission) echo 'disabled=disabled'; ?>>
                                                    <option value="">Nenhum...</option>
                                                    <option value="Clube de Poker" <?php if($this->registro['tipo_cliente'] == 'Clube de Poker') echo 'selected' ?>>Clube de Poker</option>
                                                    <option value="Home Game"<?php if($this->registro['tipo_cliente'] == 'Home Game') echo 'selected' ?>>Home Game</option>
                                                    <option value="Cassino Temático"<?php if($this->registro['tipo_cliente'] == 'Cassino Temático') echo 'selected' ?>>Cassino Temático</option>
                                                    <option value="Troféus"<?php if($this->registro['tipo_cliente'] == 'Troféus') echo 'selected' ?>>Troféus</option>
                                                    <option value="Não Respondeu"<?php if($this->registro['tipo_cliente'] == 'Não Respondeu') echo 'selected' ?>>Não quis responder</option>
                                                </select>
                                            </div><!-- End .form-group  -->
                                        </div>

                                        <div class="form-group"> </div>
                                        
                                        <?php 
                                            $cupom = 0;
                                            $avista = 0;

                                            $valor_total = $this->registro['subtotal'] + $this->registro['valor_frete'] - $this->registro['descontos'];
                                            

                                            if ($this->registro['valor_cupom']) {
                                                if ($this->registro['tipo_cupom'] != 1)
                                                    $cupom = $this->registro['valor_cupom'];
                                                else
                                                    $cupom = (($valor_total*$this->registro['valor_cupom'])/100);
                                            }

                                            $valor_total = $valor_total - $cupom;

                                            if ($this->registro['avista'] == 1) {
                                                $avista = ($valor_total * 5) /100;
                                                $valor_total = $valor_total - (($valor_total * 5) /100);
                                            }
                                        
                                        ?>

                                        <?php if ($cupom) :?>
                                            <div class="form-group">
                                                <label class="col-lg-2 control-label" for="cupom">Cupom:</label>
                                                <div class="col-lg-5">
                                                    <input readonly class="form-control" name="cupom" id="cupom" type="text" value="<?php echo $this->formataMoedaShow($cupom); ?>" />
                                                </div><!-- End .form-group  -->
                                                <div class="col-lg-5">
                                                    <input readonly class="form-control" name="cupom" id="cupom" type="text" value="<?php echo $this->registro['mensagem_cupom']; ?>" />
                                                </div><!-- End .form-group  -->
                                                
                                            </div>
                                        <?php endif;?>
                                        
                                        <div class="form-group">
                                            <label class="col-lg-2 control-label" for="subtotal">Subtotal:</label>
                                            <div class="col-lg-2">
                                                <input readonly class="form-control" onKeyUp="moeda(this);" onKeyPress="return checkIt(event)" name="subtotal" id="subtotal" type="text" value="<?php echo $this->formataMoedaShow($this->registro['subtotal']); ?>" />
                                            </div><!-- End .form-group  -->
                                            <label class="col-lg-2 control-label" for="descontos">Descontos:</label>
                                            <div class="col-lg-2">
                                                <input readonly class="form-control" onKeyUp="moeda(this);" onKeyPress="return checkIt(event)" name="descontos" id="descontos" type="text" value="<?php echo $this->formataMoedaShow($this->registro['descontos']); ?>" />
                                            </div><!-- End .form-group  -->
                                            <?php if ($this->registro['avista'] == 1) :?>
                                                <label class="col-lg-2 control-label" for="avista">Desconto À Vista:</label>
                                                <div class="col-lg-2">
                                                    <input readonly class="form-control" name="avista" id="avista" type="text" value="<?php echo $this->formataMoedaShow($avista); ?>" />
                                                </div><!-- End .form-group  -->                                                    
                                            <?php endif;?>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label class="col-lg-2 control-label" for="frete_info">Valor do Frete:</label>
                                            <div class="col-lg-2">
                                                <input readonly class="form-control" name="frete_info" id="frete_info" type="text" value="<?php if ($this->registro['valor_frete']) echo $this->formataMoedaShow($this->registro['valor_frete']); else echo 'Frete Grátis'; ?>" />
                                            </div><!-- End .form-group  -->
                                            <label class="col-lg-2 control-label" for="valor_final">Valor Total:</label>
                                            <div class="col-lg-2">
                                                <input readonly class="form-control" onKeyUp="moeda(this);" onKeyPress="return checkIt(event)" name="valor_final" id="valor_final" type="text" value="<?php echo $this->formataMoedaShow($valor_total); ?>" />
                                            </div><!-- End .form-group  -->
                                        </div>

                                        <div class="form-group"> </div>

                                        <div class="form-group">
                                            <label class="col-lg-2 control-label" for="frete">Tipo de Frete:</label>
                                            <div class="col-lg-2">
                                                <input readonly class="form-control" name="frete" id="frete" type="text" value="<?php echo $this->registro['frete']; ?>" />
                                            </div><!-- End .form-group  -->
                                            <label class="col-lg-2 control-label" for="forma_pagamento">Forma de Pagamento:</label>
                                            <div class="col-lg-2">
                                                <input readonly class="form-control" name="forma_pagamento" id="forma_pagamento" type="text" value="<?php echo $this->paymentType($this->registro['metodo_pagamento']); ?>" />
                                                <?php if($this->registro['id_empresa'] != ""){ ?>
                                                    Faturado pela: <strong><?php echo $this->registro['nome_fantasia'] ?></strong> 
                                                <?php } ?>
                                            </div><!-- End .form-group  -->
                                            <label class="col-lg-2 control-label" for="forma_pagamento">ID do Pagamento:</label>
                                            <div class="col-lg-2">
                                                <input readonly class="form-control" type="text" value="<?php echo $this->registro['metodo_pagamento_id']; ?>" />
                                            </div><!-- End .form-group  -->
                                        </div>

                                        <div class="form-group form-group-vertical">
                                            <label class="col-lg-2 col-md-3 control-label" for="id_status">Status:</label>
                                            <div class="col-lg-4">
                                                <select class="form-control input-sm" id="id_status" name="id_status" <?php if(!$this->editor_permission) echo 'disabled=disabled'; ?>>
                                                    <option value="">Selecione..</option>
                                                    <?php if ($this->status->num_rows) : ?>
                                                        <?php foreach ($this->status->rows as $status) : ?>
                                                            <option <?php if ($status['id'] == $this->registro['id_status']) echo "selected"; ?> value="<?php echo $status['id']; ?>"><?php echo $status['nome']; ?></option>
                                                        <?php endforeach; ?>
                                                    <?php endif; ?>
                                                </select>
                                            </div>
                                            <div <?php if ($_SESSION['admin_grupo'] != 2): ?> style="display:none;"<?php endif ?>>
                                                <label class="col-lg-2 control-label" for="id_vendedor">Vendedor:</label>
                                                <div class="col-lg-4">
                                                    <select class="form-control input-sm" id="id_vendedor" name="id_vendedor" <?php if(!$this->editor_permission) echo 'disabled=disabled'; ?>>
                                                        <option value="">Nenhum..</option>
                                                        <?php if ($this->usuarios->num_rows) : ?>
                                                            <?php foreach ($this->usuarios->rows as $usuario) : ?>
                                                                <option <?php if ($usuario['id'] == $this->registro['id_vendedor']) echo "selected"; ?> value="<?php echo $usuario['id']; ?>"><?php echo $usuario['nome']; ?></option>
                                                                <?php 
                                                                    if ($usuario['id'] == $this->registro['id_vendedor']) 
                                                                        $nome_vendedor = $usuario['nome'];
                                                                ?>
                                                            <?php endforeach; ?>
                                                        <?php endif; ?>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                            

                                        <!-- Este painel aparece apenas em pedidos antigos, que ainda possuem dados no campo 'observacoes gerais' -->
                                        <?php if ($this->registro['observacoes_gerais'] ?? false) :?>
                                            <div class="form-group">
                                                <label class="col-lg-2 control-label" for="observacoes_gerais">Observações Antigas</label>
                                                <div class="col-lg-10">
                                                    <textarea name="observacoes_gerais" <?php if ($_SESSION['admin_grupo'] != 2): ?>readonly<?php endif ?> class="observacoes_gerais form-control elastic" rows="3"><?php echo stripslashes( $this->registro['observacoes_gerais']); ?></textarea>
                                                </div>
                                            </div>
                                        <?php endif; ?>

                                        <div class="form-group">
                                            <label class="col-lg-2 control-label" for="observacoes">Observações</label>
                                            <div class="col-lg-10">
                                                <table id="observacoes" class="table table-striped">
                                                    <!-- Carregado por JavaScript -->
                                                </table>
                                            </div>
                                        </div>
                                        <?php if (!isset($this->read)): ?>
                                            <div class="form-group">
                                                <div class="col-lg-12" style="text-align: center;">
                                                    <a href="<?php echo $this->site_url.'/carta?p='.md5($this->registro['id']);  ?>" class="btn btn-primary btn-carta" target="_blank">Imprimir carta do Pedido</a>
                                                </div>
                                            </div>
                                        <?php endif ?>
                                        
                                        
                                        <?php if ($this->historicos->num_rows) : ?>
                                        <div class="row" style="margin-top:20px;">
                                            <div class="col-lg-12">
                                                <div class="panel panel-default toggle panelClose">
                                                    <!-- Start .panel -->
                                                    <div class="panel-heading">
                                                        <h4 class="panel-title">Histórico de Status</h4>
                                                    </div>
                                                    <div class="panel-body">
                                                        <table cellpadding="0" cellspacing="0" border="0" class="tabletools table table-striped table-bordered" width="100%">
                                                            <thead>
                                                                <tr>
                                                                    <th style="display:none"></th>
                                                                    <th width="20%" class="tal">Data</th>
                                                                    <th class="tal">Status</th>
                                                                    <th class="tal">Usuário</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <?php foreach($this->historicos->rows as $historico):?>
                                                                    <tr>
                                                                        <td style="display:none"><?php echo $historico['data'];?></td>
                                                                        <td class="tal"><?php echo $historico['registro'];?></td>
                                                                        <td class="tal"><?php echo $historico['status'];?></td>
                                                                        <td class="tal"><?php echo $historico['usuario'];?></td>
                                                                    </tr>
                                                                <?php endforeach; ?>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div><!-- End .row -->
                                        <?php endif; ?>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <?php if ($this->editor_permission): ?>
                        <?php else: ?>
                                <?php if (!isset($this->read)): ?>
                                    <div class="col-lg-10">
                                        <span class="label label-warning "><span class="icon24 typ-icon-warning"></span><?php echo $this->editor_name; ?> está editando este pedido, aguarde alguns minutos e recarregue a página para poder edita-la</span>
                                    </div>
                                    <br><br>
                                <?php endif ?>
                        <?php endif ?> 
                    
                        <?php if ($this->permissions['pedidos-documentos']['ler']): ?>

                            <div class="row">
                                <div class="col-lg-12">
                                    <div class="panel panel-default toggle">
                                        <!-- Start .panel -->
                                        <div class="panel-heading">
                                            <h4 class="panel-title">Anexar Documentos Pelo Sistema</h4>
                                        </div>
                                        <div class="panel-body">
                                            <div class="form-group">
                                                <label class="col-lg-2 control-label" for=""> <br><br><br> Documentos:</label>
                                                <input type="hidden" id="documento_padrao" value="<?php if (isset($this->documentos_padrao)) echo $this->documentos_padrao['id']; else echo 0; ?>">
                                                <div class="col-lg-2 doc_container">
                                                    <strong>Cartão Frente</strong> <br>
                                                    <div class="doc_file">
                                                        <?php if (isset($this->documentos_padrao) && $this->documentos_padrao['cartao_frente'] != ""): ?>
                                                            <?php 
                                                                $arquivo = explode(".", $this->documentos_padrao['cartao_frente']);
                                                                if(end($arquivo)=="pdf"){ 
                                                            ?>
                                                                <br><a href="<?php echo $this->upload_path . $this->documentos_padrao['cartao_frente'] ?>" target="_blank">Abrir Documento PDF.</a><br><br>
                                                            <?php }else{ ?>
                                                                <a href="<?php echo $this->upload_path . $this->documentos_padrao['cartao_frente'] ?>" rel="prettyPhoto" title="Cartão Frente"><img src="<?php echo $this->getImageFileSized($this->documentos_padrao['cartao_frente'],200,200); ?>" alt="" class="image doc_image marginR10"/></a>
                                                            <?php } ?>
                                                        <?php else: ?>
                                                            <img src="http://placehold.jp/200x200.png" alt="" class="image marginR10 doc_image"/>
                                                        <?php endif ?>
                                                    </div>
                                                    <?php if ($this->registro['id_status'] == 5 || $this->registro['id_status'] == 24): ?>
                                                        <input class="files btn btn-default anexo_documentos" name="cartao_frente" type="file" value="" />
                                                    <?php endif ?>
                                                </div>
                                                <div class="col-lg-2 doc_container">
                                                    <strong>Cartão Verso</strong> <br>
                                                    <div class="doc_file">
                                                        <?php if (isset($this->documentos_padrao) && $this->documentos_padrao['cartao_verso'] != ""): ?>
                                                            <?php 
                                                                $arquivo = explode(".", $this->documentos_padrao['cartao_verso']);
                                                                if(end($arquivo)=="pdf"){ 
                                                            ?>
                                                                <br><a href="<?php echo $this->upload_path . $this->documentos_padrao['cartao_verso'] ?>" target="_blank">Abrir Documento PDF.</a><br><br>
                                                            <?php }else{ ?>
                                                                <a href="<?php echo $this->upload_path . $this->documentos_padrao['cartao_verso'] ?>" rel="prettyPhoto" title="Cartão Verso"><img src="<?php echo $this->getImageFileSized($this->documentos_padrao['cartao_verso'],200,200); ?>" alt="" class="image doc_image marginR10"/></a>
                                                            <?php } ?>
                                                        <?php else: ?>
                                                            <img src="http://placehold.jp/200x200.png" alt="" class="image marginR10 doc_image"/>
                                                        <?php endif ?>
                                                    </div>
                                                    <?php if ($this->registro['id_status'] == 5 || $this->registro['id_status'] == 24): ?>
                                                        <input class="files btn btn-default anexo_documentos" name="cartao_verso" type="file" value="" />
                                                    <?php endif ?>
                                                </div>
                                                <div class="col-lg-2 doc_container">
                                                    <strong>Documento</strong> <br>
                                                    <div class="doc_file">
                                                        <?php if (isset($this->documentos_padrao) && $this->documentos_padrao['documento_frente'] != ""): ?>
                                                            <?php 
                                                                $arquivo = explode(".", $this->documentos_padrao['documento_frente']);
                                                                if(end($arquivo)=="pdf"){ 
                                                            ?>
                                                                <br><a href="<?php echo $this->upload_path . $this->documentos_padrao['documento_frente'] ?>" target="_blank">Abrir Documento PDF.</a><br><br>
                                                            <?php }else{ ?>
                                                                <a href="<?php echo $this->upload_path . $this->documentos_padrao['documento_frente'] ?>" rel="prettyPhoto" title="Documento Frente"><img src="<?php echo $this->getImageFileSized($this->documentos_padrao['documento_frente'],200,200); ?>" alt="" class="image doc_image marginR10"/></a>
                                                            <?php } ?>
                                                        <?php else: ?>
                                                            <img src="http://placehold.jp/200x200.png" alt="" class="image marginR10 doc_image"/>
                                                        <?php endif ?>
                                                    </div>
                                                    <?php if ($this->registro['id_status'] == 5 || $this->registro['id_status'] == 24): ?>
                                                        <input class="files btn btn-default anexo_documentos" name="documento_frente" type="file" value="" />
                                                    <?php endif ?>
                                                </div>
                                                <div class="col-lg-2 doc_container">
                                                    <strong>Documento Verso</strong> <br>
                                                    <div class="doc_file">
                                                        <?php if (isset($this->documentos_padrao) && $this->documentos_padrao['documento_verso'] != ""): ?>
                                                            <?php 
                                                                $arquivo = explode(".", $this->documentos_padrao['documento_verso']);
                                                                if(end($arquivo)=="pdf"){ 
                                                            ?>
                                                                <br><a href="<?php echo $this->upload_path . $this->documentos_padrao['documento_verso'] ?>" target="_blank">Abrir Documento PDF.</a><br><br>
                                                            <?php }else{ ?>
                                                                <a href="<?php echo $this->upload_path . $this->documentos_padrao['documento_verso'] ?>" rel="prettyPhoto" title="Documento Verso"><img src="<?php echo $this->getImageFileSized($this->documentos_padrao['documento_verso'],200,200); ?>" alt="" class="image doc_image marginR10"/></a>
                                                            <?php } ?>
                                                        <?php else: ?>
                                                            <img src="http://placehold.jp/200x200.png" alt="" class="image marginR10 doc_image"/>
                                                        <?php endif ?>
                                                    </div>
                                                    <?php if ($this->registro['id_status'] == 5 || $this->registro['id_status'] == 24): ?>
                                                        <input class="files btn btn-default anexo_documentos" name="documento_verso" type="file" value="" />
                                                    <?php endif ?>
                                                </div>
                                                <div class="col-lg-2 doc_container" style="max-height: 300px;">
                                                    <strong>Selfie</strong> <br>
                                                    <div class="doc_file">
                                                        <?php if (isset($this->documentos_padrao) && $this->documentos_padrao['selfie'] != ""): ?>
                                                            <?php 
                                                                $arquivo = explode(".", $this->documentos_padrao['selfie']);
                                                                if(end($arquivo)=="pdf"){ 
                                                            ?>
                                                                <br><a href="<?php echo $this->upload_path . $this->documentos_padrao['selfie'] ?>" target="_blank">Abrir Documento PDF.</a><br><br>
                                                            <?php }else{ ?>
                                                                <a href="<?php echo $this->upload_path . $this->documentos_padrao['selfie'] ?>" rel="prettyPhoto" title="Selfie"><img src="<?php echo $this->getImageFileSized($this->documentos_padrao['selfie'],200,200); ?>" alt="" class="image doc_image marginR10"/></a>
                                                            <?php } ?>
                                                        <?php else: ?>
                                                            <img src="http://placehold.jp/200x200.png" alt="" class="image marginR10 doc_image"/>
                                                        <?php endif ?>
                                                    </div>
                                                    <?php if ($this->registro['id_status'] == 5 || $this->registro['id_status'] == 24): ?>
                                                        <input class="files btn btn-default anexo_documentos" name="selfie" type="file" value="" />
                                                    <?php endif ?>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <?php if($this->documentos->num_rows): ?>

                                <div class="row">
                                    <div class="col-lg-12">
                                        <div class="panel panel-default toggle">
                                            <!-- Start .panel -->
                                            <div class="panel-heading">
                                                <h4 class="panel-title">Documentos Anexados Pelo Cliente</h4>
                                            </div>
                                            <div class="panel-body">
                                                <?php foreach ($this->documentos->rows as $key => $value): ?>
                                                    <?php if ($value['default'] != 1): ?>
                                                        <div class="form-group">
                                                            <label class="col-lg-2 control-label" for=""> <br><br><br> Documentos enviados <br> <?php echo $value['created_at'] ?> :</label>
                                                            <div class="col-lg-2">
                                                                <strong>Cartão Frente</strong> <br>
                                                                <?php 
                                                                    $arquivo = explode(".", $value['cartao_frente']);
                                                                    if(end($arquivo)=="pdf"){ 
                                                                ?>
                                                                    <br><a href="<?php echo $this->upload_path . $value['cartao_frente'] ?>" target="_blank">Abrir Documento PDF.</a>
                                                                <?php }else{ ?>
                                                                    <a href="<?php echo $this->upload_path . $value['cartao_frente'] ?>" rel="prettyPhoto" title="Cartão Frente"><img src="<?php echo $this->getImageFileSized($value['cartao_frente'],200,200); ?>" alt="" class="image marginR10"/></a>
                                                                <?php } ?>
                                                            </div>
                                                            <div class="col-lg-2">
                                                                <strong>Cartão Verso</strong> <br>
                                                                <?php if ($value['cartao_verso']!=""): ?>
                                                                    <?php 
                                                                        $arquivo = explode(".", $value['cartao_verso']);
                                                                        if(end($arquivo)=="pdf"){ 
                                                                    ?>
                                                                        <br><a href="<?php echo $this->upload_path . $value['cartao_verso'] ?>" target="_blank">Abrir Documento PDF.</a>
                                                                    <?php }else{ ?>
                                                                        <a href="<?php echo $this->upload_path . $value['cartao_verso'] ?>" rel="prettyPhoto" title="Cartão Verso"><img src="<?php echo $this->getImageFileSized($value['cartao_verso'],200,200); ?>" alt="" class="image marginR10"/></a>
                                                                    <?php } ?>
                                                                <?php else: ?>
                                                                    (Não enviado)
                                                                <?php endif ?>
                                                            </div>
                                                            <div class="col-lg-2">
                                                                <strong>Documento</strong> <br>
                                                                <?php 
                                                                    $arquivo = explode(".", $value['documento_frente']);
                                                                    if(end($arquivo)=="pdf"){ 
                                                                ?>
                                                                    <br><a href="<?php echo $this->upload_path . $value['documento_frente'] ?>" target="_blank">Abrir Documento PDF.</a>
                                                                <?php }else{ ?>
                                                                    <a href="<?php echo $this->upload_path . $value['documento_frente'] ?>" rel="prettyPhoto" title="Cartão Frente"><img src="<?php echo $this->getImageFileSized($value['documento_frente'],200,200); ?>" alt="" class="image marginR10"/></a>
                                                                <?php } ?>
                                                            </div>
                                                            <div class="col-lg-2">
                                                                <strong>Documento Verso</strong> <br>
                                                                <?php if ($value['documento_verso']!=""): ?>
                                                                    <?php 
                                                                        $arquivo = explode(".", $value['documento_verso']);
                                                                        if(end($arquivo)=="pdf"){ 
                                                                    ?>
                                                                        <br><a href="<?php echo $this->upload_path . $value['documento_verso'] ?>" target="_blank">Abrir Documento PDF.</a>
                                                                    <?php }else{ ?>
                                                                        <a href="<?php echo $this->upload_path . $value['documento_verso'] ?>" rel="prettyPhoto" title="Cartão Verso"><img src="<?php echo $this->getImageFileSized($value['documento_verso'],200,200); ?>" alt="" class="image marginR10"/></a>
                                                                    <?php } ?>
                                                                <?php else: ?>
                                                                    (Não enviado)
                                                                <?php endif ?>
                                                            </div>
                                                            <div class="col-lg-2" style="max-height: 300px;">
                                                                <strong>Selfie</strong> <br>
                                                                <?php 
                                                                    $arquivo = explode(".", $value['selfie']);
                                                                    if(end($arquivo)=="pdf"){ 
                                                                ?>
                                                                    <br><a href="<?php echo $this->upload_path . $value['selfie'] ?>" target="_blank">Abrir Documento PDF.</a>
                                                                <?php }else{ ?>
                                                                    <a href="<?php echo $this->upload_path . $value['selfie'] ?>" rel="prettyPhoto" title="Cartão Frente"><img src="<?php echo $this->getImageFileSized($value['selfie'],200,200); ?>" alt="" class="image marginR10"/></a>
                                                                <?php } ?>
                                                            </div>
                                                        </div>
                                                    <?php endif ?>
                                                <?php endforeach ?>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            <?php endif ?> 
                        <?php endif ?> 
                        
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="panel panel-default toggle">
                                    <!-- Start .panel -->
                                    <div class="panel-heading">
                                        <h4 class="panel-title">Produtos</h4>
                                    </div>
                                    <div class="panel-body">
                                        <?php $produtos = $this->product->getCartProductsByPedido($this->registro['id']); ?>
                                        <?php 
                                            $valor_total = 0;
                                            $cupom = 0;

                                            $valor_total = $this->registro['subtotal'] + $this->registro['valor_frete'] - $this->registro['descontos'];

                                            if ($this->registro['valor_cupom']) {
                                                if ($this->registro['tipo_cupom'] != 1)
                                                    $cupom = $this->registro['valor_cupom'];
                                                else
                                                    $cupom = (($valor_total*$this->registro['valor_cupom'])/100);
                                            }

                                            $valor_total = $valor_total - $cupom;

                                            if ($this->registro['avista'] == 1)
                                                $valor_total = $valor_total - (($valor_total * 5) /100);
                                            
                                            $valor_fabrica = "";
                                            $vfabrica_total = 0;

                                        ?>
                                        <div class="form-group">
                                            <div class="col-lg-12">
                                                
                                                <?php $c = 1; if ($produtos->num_rows) :?>
                                                <?php foreach ($produtos->rows as $produto) : ?>
                                                
                                                <?php $atributos =  $this->product->getAtributosInfoByProduto($produto['id']); ?>
                                                <div class="row">
                                                    <div class="col-lg-12">
                                                        <div class="panel panel-default toggle">
                                                            <!-- Start .panel -->
                                                            <div class="panel-heading">
                                                                <h4 class="panel-title">
                                                                    #<?php echo $c;?> - 
                                                                    <?php if ($produto['id_personalizado'] == "") :?>
                                                                        <a class="tip" style="color:#000" title="Ir Para o Produto Original" href="product/edit/id/<?php echo $produto['id_produto'];?>" target="_blank"><?php echo $produto['nome_produto'];?></a>
                                                                    <?php else :?>
                                                                        <a class="tip" style="color:#000" title="Ir Para o Produto Original" href="productcustom/edit/id/<?php echo $produto['id_personalizado'];?>" target="_blank"><?php echo $produto['nome_produto'];?></a>
                                                                    <?php endif; ?>
                                                                </h4>
                                                            </div>
                                                            <div class="panel-body produtos">
                                                                <div class="form-group" style="border-bottom:none">
                                                                    <label class="col-lg-2 control-label" for="">Detalhes:</label>
                                                                    <div class="col-lg-10" style="margin-top:7px">
                                                                        <div class="quantidade"><strong>Nome:</strong> 
                                                                        
                                                                            <?php if ($produto['id_personalizado'] == "") :?>
                                                                                <a class="tip" style="color:#000" title="Ir Para o Produto Original" href="product/edit/id/<?php echo $produto['id_produto'];?>" target="_blank"><?php echo $produto['nome_produto'];?></a>
                                                                            <?php else :?>
                                                                                <a class="tip" style="color:#000" title="Ir Para o Produto Original" href="productcustom/edit/id/<?php echo $produto['id_personalizado'];?>" target="_blank"><?php echo $produto['nome_produto'];?></a>
                                                                            <?php endif; ?>

                                                                             (<strong>SKU:</strong> <?php echo $produto['sku'];?>)
                                                                        
                                                                        </div>
                                                                        <div class="quantidade"><strong>Quantidade:</strong> <?php echo $produto['quantidade'];?></div>
                                                                        <div class="quantidade"><strong>Mesas WSOP:</strong> <?php echo $produto['mesa'];?></div>

                                                                        <?php if ($produto['desconto']):?>
                                                                            <div class="valor"><strong style="font-size: 13px;color: #333333;">Valor do Produto:</strong> De <span>R$ <?php echo $this->formataMoedaShow($produto['valor_produto']);?></span> por R$ <?php echo $this->formataMoedaShow($produto['valor_produto'] - $produto['desconto']);?></div>
                                                                            <div class="valor"><strong style="font-size: 13px;color: #333333;">Total:</strong> De <span>R$ <?php echo $this->formataMoedaShow($produto['valor_produto']*$produto['quantidade']);?></span> por R$ <?php echo $this->formataMoedaShow(($produto['valor_produto'] - $produto['desconto'])*$produto['quantidade']);?></div>
                                                                        <?php else:?>
                                                                            <div class="valor"><strong style="font-size: 13px;color: #333333;">Valor do Produto:</strong> R$ <?php echo $this->formataMoedaShow($produto['valor_produto']);?></div>
                                                                            <div class="valor"><strong style="font-size: 13px;color: #333333;">Total:</strong> R$ <?php echo $this->formataMoedaShow($produto['valor_produto']*$produto['quantidade']);?></div>
                                                                        <?php endif; ?>
                                                                        
                                                                        <?php if ($produto['descricao_desconto'] != "") :?>
                                                                            <div class="desconto"><strong>Descrição de desconto </strong><?php echo $produto['descricao_desconto'];?></div>
                                                                        <?php endif; ?>
                                                                    </div>
                                                                </div>
                                                                <div class="form-group">
                                                                    <?php if (isset($atributos->num_rows) AND $atributos->num_rows) :?>
                                                                    <?php foreach ($atributos->rows as $atributo) :?>
                                                                        <label class="col-lg-2 control-label" for=""></label>
                                                                        <div class="col-lg-5">
                                                                            <span><strong><?php echo $atributo['nome_conjunto']; ?></strong> <?php echo $atributo['nome_atributo']; ?> <?php if ($atributo['texto'] != "") echo "[{$atributo['texto']}]";?> <?php if ($atributo['cor'] != "") echo "<i style='display:inline-block;width:100px;padding:0 10px;color:#fff;background-color:{$atributo['cor']}'><i style='color: {$atributo['cor']};-webkit-filter: invert(100%);filter: invert(100%);'>{$atributo['cor']}</i></i>";?> <?php if ($atributo['arquivo'] != "") echo "[<a target='_blank' href='".$this->root_path."uploads/".$atributo['arquivo']."'>{$atributo['valor']}</a>]";?></span>
                                                                        </div>
                                                                    <?php endforeach; ?>
                                                                    <?php endif; ?>
                                                                </div>
                                                                
                                                                <div class="form-group">
                                                                    <label class="col-lg-2 control-label" for="">Anexo:</label>
                                                                    <div class="col-lg-10">
                                                                        <span class="anexo-file"><a style="padding: 10px 0;<?php if(!$produto['anexo']) echo 'display:none';?>" href="<?php echo $this->root_path.'uploads/'.$produto['anexo'] ;?>" download><?php echo $produto['anexo'] ;?></a> <a style="padding: 10px 0;<?php if(!$produto['anexo']) echo 'display:none';?>" data-id="<?php echo $produto['id'];?>" class="remove-anexo s12 icomoon-icon-cancel-circle-2 pointer"></a></span>
                                                                        <input class="files btn btn-default anexo" data-id="<?php echo $produto['id'];?>" name="arquivo" type="file" value="" />
                                                                    </div>
                                                                </div>
                                                                
                                                                <div class="form-group">
                                                                    <label class="col-lg-2 control-label" for="">Anexar Foto:</label>
                                                                    <div class="col-lg-10 identificacao_foto">
                                                                        <?php if ($produto['foto_final'] == ""): ?>
                                                                            <img src="http://placehold.jp/200x200.png" alt="" class="image marginR10 img_foto_final"/>
                                                                        <?php else: ?>
                                                                            <img src="<?php echo $this->getImageFileSized($produto['foto_final'],400,1000); ?>" alt="" class="image img_foto_final marginR10"/>
                                                                        <?php endif ?>
                                                                        <input class="files btn btn-default anexo_foto_final" data-id="<?php echo $produto['id'];?>" name="foto_final" type="file" value="" />
                                                                    </div>
                                                                </div>
                                                                
                                                                <div class="form-group node" style="border-bottom: none">
                                                                    <label class="col-lg-2 control-label" for="observacao">Observação:</label>
                                                                    <div class="col-lg-8">
                                                                        <textarea name="observacao" class="observacao form-control elastic" rows="3" <?php if(!$this->editor_permission) echo 'readonly'; ?>><?php echo stripslashes( $produto['observacao']) ?></textarea>
                                                                    </div>
                                                                    <div class="col-lg-2" style="display:none">
                                                                        <button type="button" data-id-pedido="<?php echo $this->id;?>" data-id="<?php echo $produto['id'];?>" class="btn btn-primary btn-save-observacao">Salvar observação</button>
                                                                    </div>
                                                                </div>
                                                                <?php if (!isset($this->read)): ?>
                                                                    <div class="form-group node" style="border-bottom: none">
                                                                        <label class="col-lg-2 control-label" for="observacao">Avaliação:</label>
                                                                        <div class="col-lg-8">
                                                                            <?php 
                                                                                if(!$this->avaliacoes->num_rows){
                                                                            ?>
                                                                                    <button type="button" data-id-avaliacao="" data-id-pedido="<?php echo $this->id;?>" data-id-produto="<?php echo $produto['id_produto'];?>" class="btn btn-primary btn-avaliacao">Avaliar Este Produto</button>
                                                                            <?php 
                                                                                }else{
                                                                                    $flag_review = true;
                                                                                    foreach ($this->avaliacoes->rows as $avaliacao) {
                                                                                        if ($avaliacao['id_produto'] == $produto['id_produto']) {
                                                                                            $flag_review = false;
                                                                            ?>
                                                                                    <button type="button" data-id-avaliacao="<?php echo $avaliacao['id'] ?>" class="btn btn-primary btn-avaliacao">Visualizar Avaliação</button>
                                                                            <?php
                                                                                        }
                                                                                    }
                                                                                    if($flag_review){
                                                                            ?>
                                                                                    <button type="button" data-id-avaliacao="" data-id-pedido="<?php echo $this->id;?>" data-id-produto="<?php echo $produto['id_produto'];?>" class="btn btn-primary btn-avaliacao">Avaliar Este Produto</button>
                                                                            <?php

                                                                                    }
                                                                                } 
                                                                            ?>

                                                                        </div>
                                                                    </div>
                                                                <?php endif ?>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <?php $c++; endforeach;?>
                                                <?php endif;?>

                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <?php if ($this->editor_permission): ?>
                        <?php else: ?>
                                <?php if (!isset($this->read)): ?>
                                    <div class="col-lg-10">
                                        <span class="label label-warning "><span class="icon24 typ-icon-warning"></span><?php echo $this->editor_name; ?> está editando este pedido, aguarde alguns minutos e recarregue a página para poder edita-la</span>
                                    </div>
                                    <br><br>
                                <?php endif ?>
                        <?php endif ?> 
                        <?php if ($this->editor_permission): ?>
                        <?php else: ?>
                                <?php if (!isset($this->read)): ?>
                                    <div class="col-lg-10">
                                        <span class="label label-warning "><span class="icon24 typ-icon-warning"></span><?php echo $this->editor_name; ?> está editando este pedido, aguarde alguns minutos e recarregue a página para poder edita-la</span>
                                    </div>
                                    <br><br>
                                <?php endif ?>
                        <?php endif ?> 
                        
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="panel panel-default toggle">
                                    <!-- Start .panel -->
                                    <div class="panel-heading">
                                        <h4 class="panel-title">Endereço</h4>
                                    </div>
                                    <div class="panel-body">
                                        <?php $endereco = $this->product->getEnderecoByPedido($this->registro['id']);  ?>
                                        <div class="form-group">
                                            <label class="col-lg-2 control-label" for="cep">Cep:</label>
                                            <div class="col-lg-2">
                                                <input class="form-control" name="cep" id="cep" type="text" value="<?php echo $endereco->rows[0]['cep'];?>" readonly/>
                                            </div><!-- End .form-group  -->
                                            <label class="col-lg-1 control-label" for="endereco">Endereço:</label>
                                            <div class="col-lg-7">
                                                <input class="form-control" name="endereco" id="endereco" type="text" value="<?php echo $endereco->rows[0]['endereco'];?>" readonly/>
                                            </div><!-- End .form-group  -->
                                        </div>
                                        <div class="form-group">
                                            <label class="col-lg-2 control-label" for="numero">Número:</label>
                                            <div class="col-lg-1">
                                                <input class="form-control" name="numero" id="numero" type="text" value="<?php echo $endereco->rows[0]['numero'];?>" readonly/>
                                            </div><!-- End .form-group  -->
                                            <label class="col-lg-1 control-label" for="bairro">Bairro:</label>
                                            <div class="col-lg-3">
                                                <input class="form-control" name="bairro" id="bairro" type="text" value="<?php echo $endereco->rows[0]['bairro'];?>" readonly/>
                                            </div><!-- End .form-group  -->
                                            <label class="col-lg-1 control-label" for="complemento">Complemento:</label>
                                            <div class="col-lg-4">
                                                <input class="form-control" name="complemento" id="complemento" type="text" value="<?php echo $endereco->rows[0]['complemento'];?>" readonly/>
                                            </div><!-- End .form-group  -->
                                        </div>
                                        
                                        <div class="form-group form-group-vertical">
                                            <label class="col-lg-2 control-label" for="id_estado">Estado:</label>
                                            <div class="col-lg-4">
                                                <select class="form-control input-sm" id="id_estado" name="id_estado">
                                                    <option value="">Selecione..</option>
                                                    <?php if ($this->estados->num_rows) : ?>
                                                        <?php foreach ($this->estados->rows as $estado) : ?>
                                                            <option <?php if ($estado['id'] == $endereco->rows[0]['id_estado']) echo "selected"; ?> value="<?php echo $estado['id']; ?>"><?php echo $estado['estado']; ?></option>
                                                        <?php endforeach; ?>
                                                    <?php endif; ?>
                                                </select>
                                            </div>
                                            <label class="col-lg-2 control-label" for="id_cidade">Cidade:</label>
                                            <div class="col-lg-4">
                                                <select class="form-control input-sm" id="id_cidade" name="id_cidade" disabled>
                                                    <option value="">Selecione..</option>
                                                    
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <?php if ($this->editor_permission): ?>
                        <?php else: ?>
                                <?php if (!isset($this->read)): ?>
                                    <div class="col-lg-10">
                                        <span class="label label-warning "><span class="icon24 typ-icon-warning"></span><?php echo $this->editor_name; ?> está editando este pedido, aguarde alguns minutos e recarregue a página para poder edita-la</span>
                                    </div>
                                    <br><br>
                                <?php endif ?>
                        <?php endif ?> 

                        <div class="row">
                            <div class="col-lg-12">
                                <div class="panel panel-default toggle">
                                    <!-- Start .panel -->
                                    <div class="panel-heading">
                                        <h4 class="panel-title">Dados da Entrega</h4>
                                    </div>
                                    <div class="panel-body">
                                        <div class="form-group">
                                            <label class="col-lg-2 control-label" for="entrega_transportadora">Transportadora:</label>
                                            <div class="col-lg-10">
                                                <input class="form-control" name="entrega_transportadora" id="entrega_transportadora" type="text" value="<?php echo $this->registro['entrega_transportadora']; ?>" <?php if(!$this->editor_permission) echo 'readonly'; ?> />
                                            </div><!-- End .form-group  -->
                                        </div>
                                        <div class="form-group">
                                            <label class="col-lg-2 control-label" for="entrega_cotacao">Cotação (número):</label>
                                            <div class="col-lg-4">
                                                <input class="form-control" name="entrega_cotacao" id="entrega_cotacao" type="text" value="<?php echo $this->registro['entrega_cotacao']; ?>" <?php if(!$this->editor_permission) echo 'readonly'; ?> />
                                            </div><!-- End .form-group  -->
                                            <label class="col-lg-2 control-label" for="entrega_coleta">Coleta (número):</label>
                                            <div class="col-lg-4">
                                                <input class="form-control" name="entrega_coleta" id="entrega_coleta" type="text" value="<?php echo $this->registro['entrega_coleta']; ?>" <?php if(!$this->editor_permission) echo 'readonly'; ?> />
                                            </div><!-- End .form-group  -->
                                        </div>
                                        <div class="form-group">
                                            <label class="col-lg-2 control-label" for="entrega_valor">Valor:</label>
                                            <div class="col-lg-2">
                                                <input class="form-control" name="entrega_valor" id="entrega_valor" type="text" value="<?php echo $this->registro['entrega_valor']; ?>" <?php if(!$this->editor_permission) echo 'readonly'; ?> />
                                            </div><!-- End .form-group  -->
                                            <label class="col-lg-2 control-label" for="dias_entrega">Prazo de entrega :</label>
                                            <div class="col-lg-2">
                                                <input class="form-control" name="dias_entrega" id="dias_entrega" type="text" value="<?php echo $this->registro['dias_entrega']; ?> dias úteis" readonly />
                                            </div><!-- End .form-group  -->
                                            <label class="col-lg-2 control-label" for="entrega_dia_coleta">Dia da Coleta:</label>
                                            <div class="col-lg-2">
                                                <input class="form-control" name="entrega_dia_coleta" id="entrega_dia_coleta" type="text" value="<?php echo $this->registro['entrega_dia_coleta']; ?>" <?php if(!$this->editor_permission) echo 'readonly'; ?> />
                                            </div><!-- End .form-group  -->
                                        </div>                               
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <?php if ($this->editor_permission): ?>
                        <?php else: ?>
                                <?php if (!isset($this->read)): ?>
                                    <div class="col-lg-10">
                                        <span class="label label-warning "><span class="icon24 typ-icon-warning"></span><?php echo $this->editor_name; ?> está editando este pedido, aguarde alguns minutos e recarregue a página para poder edita-la</span>
                                    </div>
                                    <br><br>
                                <?php endif ?>
                        <?php endif ?> 

                        <div class="row">
                            <div class="col-lg-12">
                                <div class="panel panel-default toggle">
                                    <!-- Start .panel -->
                                    <div class="panel-heading">
                                        <h4 class="panel-title">Rastreios</h4>
                                    </div>
                                    <div class="panel-body">
                                        
                                        <div class="form-group">
                                            <label class="col-lg-2 control-label" for="prazo_entrega">Previsão de Entrega:</label>
                                            <div class="col-lg-10">
                                                <input class="form-control data" name="prazo_entrega" id="prazo_entrega" type="text" value="<?php echo $this->registro['prazo_entrega'] ?>" <?php if(!$this->editor_permission) echo 'readonly'; ?> />
                                            </div><!-- End .form-group  -->
                                        </div>
                                        
                                        <span id="rastreios">
                                            <?php if ($this->rastreios->num_rows):?>
                                            <?php foreach($this->rastreios->rows as $rastreio):?>
                                                <div class="form-group node">
                                                    <label class="col-lg-2 control-label">Rastreio:</label>
                                                    <div class="col-lg-3">
                                                        <input placeholder="Descrição" class="form-control descricao" name="descricao[]" type="text" value="<?php echo $rastreio['descricao'];?>"<?php if(!$this->editor_permission) echo 'readonly'; ?> />
                                                    </div>
                                                    <div class="col-lg-3">
                                                        <input placeholder="Link" class="form-control link" name="link[]" type="text" value="<?php echo $rastreio['link'];?>"<?php if(!$this->editor_permission) echo 'readonly'; ?> />
                                                    </div>
                                                    <div class="col-lg-2">
                                                        <input disabled class="form-control rastreio_msg" type="text" value="<?php if($rastreio['stats']) echo 'Entregue' ; else echo 'Despachado';?>" />
                                                        <input class="form-control rastreio_stats" name="rastreio_stats[]" type="hidden" value="<?php echo $rastreio['stats'];?>" />
                                                    </div>
                                                    <div class="col-lg-2">
                                                        <?php if ($this->editor_permission): ?>
                                                            <button type="button" class="btn btn-danger btn-minus">-</button>
                                                            <button type="button" class="btn btn-primary btn-plus">+</button>
                                                        <?php endif ?>
                                                    </div>
                                                </div>
                                            <?php endforeach;?>
                                            <?php else:?>
                                                <div class="form-group node">
                                                    <label class="col-lg-2 control-label">Rastreio:</label>
                                                    <div class="col-lg-3">
                                                        <input placeholder="Descrição" class="form-control descricao" name="descricao[]" type="text" value="" <?php if(!$this->editor_permission) echo 'readonly'; ?> />
                                                    </div>
                                                    <div class="col-lg-3">
                                                        <input placeholder="Link" class="form-control link" name="link[]" type="text" value="" <?php if(!$this->editor_permission) echo 'readonly'; ?> />
                                                    </div>
                                                    <div class="col-lg-2">
                                                        <input disabled class="form-control" type="text" value="Despachar" />
                                                        <input class="form-control" name="rastreio_stats[]" type="hidden" value="0" />
                                                    </div>
                                                    <div class="col-lg-2">
                                                        <?php if ($this->editor_permission): ?>
                                                            <button type="button" class="btn btn-danger btn-minus">-</button>
                                                            <button type="button" class="btn btn-primary btn-plus">+</button>
                                                        <?php endif ?>
                                                    </div>
                                                </div>
                                            <?php endif;?>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-lg-12">
                                <div class="panel panel-default toggle">
                                    <!-- Start .panel -->
                                    <div class="panel-heading">
                                        <h4 class="panel-title">Extrato Financeiro</h4>
                                    </div>
                                    <div class="panel-body">
                                        <table cellpadding="0" cellspacing="0" border="0" class="tabletools table table-striped table-bordered" width="100%">
                                            <thead>
                                                <tr>
                                                    <th style="display:none">ordem</th>
                                                    <th class="tal">Descrição</th>
                                                    <th class="tal">Valor</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <?php 
                                                    $primeiro_nome = explode(" ", $this->registro['cliente']);
                                                    $primeiro_nome = $primeiro_nome[0];

                                                    $i = $this->extrato_financeiro->num_rows * 2;

                                                    if ($this->registro['avista']==1) {
                                                        $desc_avista = 0.95;
                                                    }else{
                                                        $desc_avista = 1;
                                                    }


                                                ?>
                                                <?php foreach($this->extrato_financeiro->rows as $row){ ?>
                                                    <tr>
                                                        <td style="display:none"><?php echo $i ?></td>
                                                        <td class="tal">Pedido (<?php echo  $this->registro['id'] ?>) - <?php echo $row['categoria']; ?> - <?php echo $primeiro_nome ?></td>
                                                        <td class="tal">R$ <?php echo $this->formataMoedaShow($row['total_sem_frete']*$desc_avista); ?></td>
                                                    </tr>
                                                    <?php $i--; ?>
                                                    <tr>
                                                        <td style="display:none"><?php echo $i ?></td>
                                                        <td class="tal">Frete Pedido (<?php echo  $this->registro['id'] ?>) - <?php echo $row['categoria']; ?> - <?php echo $primeiro_nome ?></td>
                                                        <td class="tal">R$ <?php echo $this->formataMoedaShow($row['total_frete']*$desc_avista); ?></td>
                                                    </tr>
                                                    <?php $i--; ?>
                                                <?php } ?>
                                                <?php if ($this->registro['id_vendedor'] != '' && $this->registro['id_vendedor'] != 0): ?>
                                                <tr>
                                                    <td style="display:none"></td>
                                                    <td class="tal">Comissão <?php echo $nome_vendedor ?> (<?php echo  $this->registro['id'] ?>) - <?php echo $primeiro_nome ?></td>
                                                    <td class="tal">R$ <?php echo $this->formataMoedaShow($valor_total * $this->registro['porcentagem_comissao'] /100); ?></td>
                                                </tr>
                                                <?php endif ?>
                                                <?php if ($this->registro['valor_frete'] > 0): ?>
                                                <tr>
                                                    <td style="display:none"></td>
                                                    <td class="tal">Frete Adicional (<?php echo  $this->registro['id'] ?>) - <?php echo $primeiro_nome ?></td>
                                                    <td class="tal">R$ <?php echo $this->formataMoedaShow($this->registro['valor_frete']*$desc_avista); ?></td>
                                                </tr>
                                                <?php endif ?>
                                                <?php if ($this->registro['valor_cupom'] > 0): ?>
                                                <tr>
                                                    <td style="display:none"></td>
                                                    <td class="tal">Cupom (<?php echo  $this->registro['id'] ?>) - <?php echo $primeiro_nome ?></td>
                                                    <td class="tal">R$ <?php echo $this->formataMoedaShow($cupom*$desc_avista); ?></td>
                                                </tr>
                                                <?php endif ?>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="panel panel-default toggle">
                                    <!-- Start .panel -->
                                    <div class="panel-heading">
                                        <h4 class="panel-title">Extrato Financeiro Novo</h4>
                                    </div>
                                    <div class="panel-body">
                                        <div class="form-group">
                                            <label class="col-lg-1 control-label" for="id">Valor Total:</label>
                                            <div class="col-lg-4">
                                                <input class="form-control" onKeyUp="moeda(this);" onKeyPress="return checkIt(event)" id="valor_final_ca" type="text" value="<?php echo $this->formataMoedaShow($valor_total); ?>" style="display: inline; width: auto;" />
                                                <?php if ($this->registro['contaazul_id']!=""): ?>
                                                    Este pedido já foi lançado na Conta Azul: <strong>(nº <?php echo $this->registro['contaazul_number']; ?>) </strong> <br><br>
                                                    <a href="javascript:;" class="btn btn-primary contaazul_submit">LANÇAR NOVAMENTE CONTA AZUL</a><br>
                                                <?php else: ?>
                                                    <a href="javascript:;" class="btn btn-primary contaazul_submit">LANÇAR NO CONTA AZUL</a>
                                                <?php endif ?>
                                            </div>
                                        </div>

                                        <table cellpadding="0" cellspacing="0" border="0" class="tabletools table table-striped table-bordered" width="100%">
                                            <thead>
                                                <tr>
                                                    <th style="display:none">ordem</th>
                                                    <th></th>
                                                    <th class="tal">Descrição</th>
                                                    <th class="tal">Quantidade</th>
                                                    <th class="tal">Valor</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <?php 
                                                    $primeiro_nome = explode(" ", $this->registro['cliente']);
                                                    $primeiro_nome = $primeiro_nome[0];

                                                    $i = $this->extrato_financeiro2->num_rows;
                                                    $j = 1;

                                                    $total_frete_embutido = 0;

                                                    if ($this->registro['avista']==1) {
                                                        $desc_avista = 0.95;
                                                    }else{
                                                        $desc_avista = 1;
                                                    }


                                                ?>
                                                <?php foreach($this->extrato_financeiro2->rows as $row){ ?>
                                                    <tr>
                                                        <td style="display:none"><?php echo $i+4 ?></td>
                                                        <td><?php echo '#'.$j ?></td>
                                                        <td class="tal">Pedido (<?php echo  $this->registro['id'] ?>) - <?php echo $row['nome']; ?> - <?php echo $primeiro_nome ?></td>
                                                        <td><?php echo $row['quantidade'] ?></td>
                                                        <td class="tal">R$ <?php echo $this->formataMoedaShow($row['total_sem_frete']*$desc_avista); ?></td>
                                                    </tr>
                                                    <?php
                                                        $i--;
                                                        $j++;
                                                        $total_frete_embutido = $total_frete_embutido+$row['total_frete_embutido'];
                                                    ?>
                                                <?php } ?>
                                                <tr>
                                                    <td style="display:none">4</td>
                                                    <td></td>
                                                    <td class="tal">Total Frete Embutido - <?php echo $primeiro_nome ?></td>
                                                    <td>1</td>
                                                    <td class="tal">R$ <?php echo $this->formataMoedaShow($total_frete_embutido*$desc_avista); ?></td>
                                                </tr>
                                                <?php if ($this->registro['valor_frete'] > 0): ?>
                                                <tr>
                                                    <td style="display:none">3</td>
                                                    <td></td>
                                                    <td class="tal">Frete Adicional (<?php echo  $this->registro['id'] ?>) - <?php echo $primeiro_nome ?></td>
                                                    <td>1</td>
                                                    <td class="tal">R$ <?php echo $this->formataMoedaShow($this->registro['valor_frete']*$desc_avista); ?></td>
                                                </tr>
                                                <?php endif ?>
                                                <?php if ($this->registro['valor_cupom'] > 0): ?>
                                                <tr style="color:red;">
                                                    <td style="display:none">2</td>
                                                    <td></td>
                                                    <td class="tal">Cupom (<?php echo  $this->registro['id'] ?>) - <?php echo $primeiro_nome ?></td>
                                                    <td>1</td>
                                                    <td class="tal">R$ - <?php echo $this->formataMoedaShow($cupom*$desc_avista); ?></td>
                                                </tr>
                                                <?php endif ?>
                                                <?php if ($this->registro['id_vendedor'] != '' && $this->registro['id_vendedor'] != 0): ?>
                                                <tr style="color:gray;">
                                                    <td style="display:none">1</td>
                                                    <td></td>
                                                    <td class="tal">Comissão <?php echo $nome_vendedor ?> (<?php echo  $this->registro['id'] ?>) - <?php echo $primeiro_nome ?></td>
                                                    <td>1</td>
                                                    <td class="tal">R$ <?php echo $this->formataMoedaShow($valor_total * $this->registro['porcentagem_comissao'] /100); ?></td>
                                                </tr>
                                                <?php endif ?>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <?php if ($this->editor_permission): ?>
                        <?php else: ?>
                                <?php if (!isset($this->read)): ?>
                                    <div class="col-lg-10">
                                        <span class="label label-warning "><span class="icon24 typ-icon-warning"></span><?php echo $this->editor_name; ?> está editando este pedido, aguarde alguns minutos e recarregue a página para poder edita-la</span>
                                    </div>
                                    <br><br>
                                <?php endif ?>
                        <?php endif ?> 
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="panel panel-default toggle">
                                    <!-- Start .panel -->
                                    <div class="panel-heading">
                                        <h4 class="panel-title">Faturar Nota</h4>
                                    </div>
                                    <div class="panel-body">
                                        <div class="form-group">
                                            <label class="col-lg-2 control-label" for="idNotaFiscal">ID Nota Fiscal:</label>
                                            <div class="col-lg-10">
                                                <input class="form-control" name="idNotaFiscal" id="idNotaFiscal" type="text" value="<?php echo $this->registro['idNotaFiscal'];?>" readonly/>
                                            </div><!-- End .form-group  -->
                                        </div>
                                        
                                        <div class="form-group">
                                            <label class="col-lg-2 control-label" for="n_nota">Número da Nota:</label>
                                            <div class="col-lg-10">
                                                <input class="form-control" name="n_nota" id="n_nota" type="text" value="<?php echo $this->registro['n_nota'];?>" readonly/>
                                            </div><!-- End .form-group  -->
                                        </div>

                                        <div class="form-group">
                                            <label class="col-lg-2 control-label" for="faturado_por">Faturado por:</label>
                                            <div class="col-lg-10">
                                                <input class="form-control" name="faturado_por" id="faturado_por" type="text" value="<?= $this->registro['empresa_faturado'] ? $this->registro['empresa_faturado'] : $this->registro['faturado_por']; ?>" readonly/>
                                            </div><!-- End .form-group  -->
                                        </div>
                                        <div class="form-group" style="display:none">
                                            <label class="col-lg-2 control-label" for="serie">Série:</label>
                                            <div class="col-lg-10">
                                                <input class="form-control" name="serie" id="serie" type="text" value="<?php echo $this->registro['serie'];?>" readonly/>
                                            </div><!-- End .form-group  -->
                                        </div>
                                        <div class="form-group" style="display:none">
                                            <label class="col-lg-2 control-label" for="codigo_rastreamento">Código de Rastreamento:</label>
                                            <div class="col-lg-10">
                                                <input class="form-control" name="codigo_rastreamento" id="codigo_rastreamento" type="text" value="<?php echo $this->registro['codigo_rastreamento'];?>" readonly/>
                                            </div><!-- End .form-group  -->
                                        </div>
                                        <div class="form-group" style="display:none">
                                            <label class="col-lg-2 control-label" for="mensagem">Mensagem:</label>
                                            <div class="col-lg-10">
                                                <input class="form-control" name="mensagem" id="mensagem" type="text" value="<?php echo $this->registro['mensagem'];?>" readonly/>
                                            </div><!-- End .form-group  -->
                                        </div>
                                        <div class="form-group" style="display:none">
                                            <label class="col-lg-2 control-label" for="chaveAcesso">Chave de Acesso:</label>
                                            <div class="col-lg-10">
                                                <input class="form-control" name="chaveAcesso" id="chaveAcesso" type="text" value="<?php echo $this->registro['chaveAcesso'];?>" readonly/>
                                            </div><!-- End .form-group  -->
                                        </div>
                                        <div class="form-group" style="display:none">
                                            <label class="col-lg-2 control-label" for="linkDanfe">Link Danfe:</label>
                                            <div class="col-lg-10">
                                                <input class="form-control" name="linkDanfe" id="linkDanfe" type="text" value="<?php echo $this->registro['linkDanfe'];?>" readonly/>
                                            </div><!-- End .form-group  -->
                                        </div>
                                        <?php if (!isset($this->read)): ?>
                                            <div class="form-group">
                                                <div class="col-lg-offset-2 col-lg-10">
                                                    <?php if (!$this->registro['n_nota']): ?>
                                                        <?php foreach($this->contas_bling->rows as $row){ ?>
                                                            <button type="button" data-emitente="<?php echo $row['id'] ?>" class="btn btn-success btn-faturar">Faturar pela <?php echo $row['nome_fantasia']; ?></button>
                                                        <?php } ?>
                                                    <?php endif ?>
                                                </div>
                                            </div>
                                        <?php endif ?>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        
                        <?php if ($this->editor_permission): ?>
                        <?php else: ?>
                                <?php if (!isset($this->read)): ?>
                                    <div class="col-lg-10">
                                        <span class="label label-warning "><span class="icon24 typ-icon-warning"></span><?php echo $this->editor_name; ?> está editando este pedido, aguarde alguns minutos e recarregue a página para poder edita-la</span>
                                    </div>
                                    <br><br>
                                <?php endif ?>
                        <?php endif ?> 
                        
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="panel panel-default toggle">
                                    <!-- Start .panel -->
                                    <div class="panel-heading">
                                        <h4 class="panel-title">Enviar E-mail</h4>
                                    </div>
                                    <div class="panel-body">
                                        <span id="notificacoes">
                                            <span class="node">
                                                <div class="form-group">
                                                    <label class="col-lg-2 control-label" for="nome_notificacao">Pessoa:</label>
                                                    <div class="col-lg-3">
                                                        <input class="form-control" name="nome_notificacao[]" class="nome_notificacao" placeholder="Nome da Pessoa" type="text" value="" />
                                                    </div><!-- End .form-group  -->
                                                    <div class="col-lg-3">
                                                        <input class="form-control" name="email_notificacao[]" class="email_notificacao" placeholder="E-mail da Pessoa" type="text" value="" />
                                                    </div><!-- End .form-group  -->
                                                    <div class="col-lg-2">
                                                        <label class="pointer" for="alvo_notificacao1"><input class="form-control" name="alvo_notificacao[0][]" id="alvo_notificacao1" type="checkbox" value="financeiro" />Financeiro</label>
                                                        <label class="pointer" for="alvo_notificacao2"><input class="form-control" name="alvo_notificacao[0][]" id="alvo_notificacao2" type="checkbox" value="fabrica" />Fábrica</label>
                                                    </div><!-- End .form-group  -->
                                                    <div class="col-lg-2">
                                                            <button type="button" class="btn btn-primary btn-plus-notificacao">+</button>
                                                    </div>
                                                </div>
                                                <div class="form-group" style="border-bottom: 1px solid #ccc">
                                                    <label class="col-lg-2 control-label" for="">Produtos:</label>
                                                    <div class="col-lg-10 col-md-9">
                                                        <?php if ($produtos->num_rows) :?>
                                                        <?php foreach ($produtos->rows as $produto) :?>
                                                        <label class="pointer" for="produto_<?php echo $produto['id'];?>"><input checked class="form-control" name="produtos[0][]" id="produto_<?php echo $produto['id'];?>" type="checkbox" value="<?php echo $produto['id'];?>" /><?php echo $produto['nome_produto'];?></label><br>
                                                        <?php endforeach; ?>
                                                        <?php endif; ?>
                                                    </div>
                                                </div>
                                            </span>
                                        </span>
                                        <div class="form-group">
                                        <div class="col-lg-offset-2 col-lg-10" align="center">
                                            <?php if (!isset($this->read)): ?><button type="button" class="btn btn-primary btn-send-email">Enviar E-mail(s)</button><?php endif ?>
                                        </div>
                                    </div><!-- End .form-group  -->
                                    
                                    <?php if ($this->id) :?>
                                    <?php if ($this->historico_emails->num_rows) : ?>
                                    <div class="row">
                                        <div class="col-lg-12">
                                            <div class="panel panel-default toggle panelClose">
                                                <!-- Start .panel -->
                                                <div class="panel-heading">
                                                    <h4 class="panel-title">Histórico de E-mails Enviados</h4>
                                                </div>
                                                <div class="panel-body">
                                                    <table cellpadding="0" cellspacing="0" border="0" class="tabletools table table-striped table-bordered" width="100%">
                                                        <thead>
                                                            <tr>
                                                                <th style="display:none"></th>
                                                                <th width="20%" class="tal">Data</th>
                                                                <th class="tal">Alvo</th>
                                                                <th class="tal">E-mail</th>
                                                                <th class="tal">Link</th>
                                                                <th class="tal">Usuário</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <?php foreach($this->historico_emails->rows as $email):?>
                                                                <tr>
                                                                    <td style="display:none"><?php echo $email['data'];?></td>
                                                                    <td class="tal"><?php echo $email['registro'];?></td>
                                                                    <td class="tal"><?php echo $email['alvo'];?></td>
                                                                    <td class="tal"><?php echo $email['email'];?></td>
                                                                    <td class="tal"><a target="_blank" href="<?php echo $email['link'];?>">Link</a> - <a target="_blank" href="<?php echo $this->site_url.'/carta?p='.$this->embaralhar($this->registro['id']);  ?>">Carta</a></td>
                                                                    <td class="tal"><?php echo $email['usuario'];?></td>
                                                                </tr>
                                                            <?php endforeach; ?>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div><!-- End .row -->
                                    <?php endif; ?>
                                    <?php endif; ?>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        
                        <div class="row">
                            <?php if ($this->editor_permission): ?>
                                
                                <?php if ($this->id==""): ?>
                                    <?php if (!$this->permissions[$this->permissao_ref]['gravar']): ?>
                                        <div class="form-group">
                                            <div class="col-lg-offset-2 col-lg-10">
                                                <span class="label label-warning "><span class="icon24 typ-icon-warning"></span>Você não tem permissão para gravar esta função.</span>
                                            </div>
                                        </div><!-- End .form-group  -->   
                                    <?php else: ?>
                                        <div class="form-group">
                                            <div class="col-lg-offset-2 col-lg-10">
                                                <button type="button" class="btn btn-info clickformsubmit_">Salvar novo</button>
                                            </div>
                                        </div><!-- End .form-group  -->
                                    <?php endif ?>
                                <?php else: ?>
                                    <?php if (!$this->permissions[$this->permissao_ref]['editar']): ?>
                                        <div class="form-group">
                                            <div class="col-lg-offset-2 col-lg-10">
                                                <span class="label label-warning"><span class="icon24 icomoon-icon-warning "></span>Você não tem permissão para editar esta função.</span>
                                            </div>
                                        </div><!-- End .form-group  -->   
                                    <?php else: ?>
                                        <div class="form-group">
                                            <div class="col-lg-offset-2 col-lg-10">
                                                <button type="button" class="btn btn-info clickformsubmit_">Salvar alterações</button>
                                                <div class="fixed_save">
                                                    <?php if(!$this->ordens_producao->num_rows) : ?>
                                                    <button type="button" class="btn btn-warning btn_fabricar">Enviar para produção</button>
                                                    <?php endif; ?>
                                                    <button type="button" class="btn btn-success clickformsubmit_">Salvar alterações</button>
                                                    <button type="button" class="btn btn-info btn_continuar">Salvar e continuar</button>
                                                </div>
                                            </div>
                                        </div><!-- End .form-group  -->
                                    <?php endif ?>
                                <?php endif ?>
                            <?php else: ?>
                                    <?php if (!isset($this->read)): ?>
                                        
                                        <div class="form-group">
                                            <div class="col-lg-10">
                                                <span class="label label-warning "><span class="icon24 typ-icon-warning"></span><?php echo $this->editor_name; ?> está editando este pedido, aguarde alguns minutos e recarregue a página para poder edita-la</span>
                                            </div>
                                        </div><!-- End .form-group  -->  

                                    <?php endif ?>
                            <?php endif ?>
                        </div><!-- End .row -->  
                                               
                        
                        <div class="row" style="display: none;">
                            <div class="col-lg-12">
                                <div class="panel panel-default toggle">
                                    <!-- Start .panel -->
                                    <div class="panel-heading">
                                        <h4 class="panel-title">Dados da Navegação</h4>
                                    </div>
                                    <div class="panel-body">
                                        <div class="form-group">
                                            <label class="col-lg-2 control-label" for="ip">IP:</label>
                                            <div class="col-lg-10">
                                                <input class="form-control" name="ip" id="ip"  type="text" value="<?php echo $this->registro['ip'] ?>" readonly />
                                            </div>
                                        </div><!-- End .form-group  -->
                                        <div class="form-group">
                                            <label class="col-lg-2 control-label" for="">Sessão:</label>
                                            <div class="col-lg-10">
                                                <input class="form-control" name="" id=""  type="text" value="<?php echo $session ?>" readonly />
                                            </div>
                                        </div><!-- End .form-group  -->
                                        <div class="form-group">
                                            <label class="col-lg-2 control-label" for="">Origem:</label>
                                            <div class="col-lg-10">
                                                <input class="form-control" name="" id=""  type="text" value="<?php echo $origem ?>" readonly />
                                            </div>
                                        </div><!-- End .form-group  -->
                                        <div class="form-group">
                                            <label class="col-lg-2 control-label" for="">Localização:</label>
                                            <div class="col-lg-10">
                                                <input class="form-control" name="" id=""  type="text" value="<?php echo $localizacao ?>" readonly />
                                            </div>
                                        </div><!-- End .form-group  -->
                                        <div class="form-group">
                                            <label class="col-lg-2 control-label" for="">Dispositivo:</label>
                                            <div class="col-lg-10">
                                                <input class="form-control" name="" id=""  type="text" value="<?php echo $dispositivo ?>" readonly />
                                            </div>
                                        </div><!-- End .form-group  -->
                                    </div>
                                </div><!-- End .panel -->
                            </div><!-- End .span12 -->
                        </div><!-- End .row -->
                    </form>

                    <form action="javascript:;" name="savecontaazul" method="post">
                        <input type="hidden" name="pedido_valor_total" value="">
                        <a href="javascript:;" class="btn btn-primary contaazul_submit_official" style="display: none;"></a>
                    </form>
                    
                    
                    <div class="row" style="display: none;">
                        <div class="col-lg-12">
                            <div class="panel panel-default toggle">
                                <!-- Start .panel -->
                                <div class="panel-heading">
                                    <h4 class="panel-title">Histórico da Navegação</h4>
                                </div>
                                <div class="panel-body">
                                    <table cellpadding="0" cellspacing="0" border="0" class="tabletools table table-striped table-bordered" width="100%">
                                        <thead>
                                            <tr>
                                                <th style="display:none"></th>
                                                <th width="10%" class="tal">Data</th>
                                                <th class="tal" width="20%">Página</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <?php if($this->historicosnav->num_rows){ ?>
                                                <?php foreach($this->historicosnav->rows as $row){ ?>
                                                    <tr>
                                                        <td style="display:none"><?php echo $row['date']; ?>"></td>
                                                        <td class="tal"><?php echo $row['registro']; ?></td>
                                                        <td class="tal"><?php echo $row['titulo']; ?></td>
                                                    </tr>
                                                <?php } ?>
                                            <?php } ?>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End contentwrapper -->
            </div>
            <!-- End #content -->
            
            
<?php  require_once "layouts/footer.phtml"; ?>
        
        </div>

        <div class="modal fade" id="modal-fabricar" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog" style="width:50vw; height:90vh;">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">
                            <span aria-hidden="true">&times;</span><span class="sr-only">Close</span>
                        </button>
                        <h4 class="modal-title" id="myModalLabel">Enviar pedido para produção</h4>
                    </div>
                    <div class="modal-body">
                        <form name="producao" enctype="multipart/form-data" method="post" class="form-horizontal group-border">
                            <input class="clickformProducao" type="hidden" name="id" value="<?php echo $this->id; ?>" />

                            <div class="row">
                                <div class="col-lg-12">
                                    <!-- REMESSA -->
                                    <div class="remessas_content">
                                        <button type="button" class="btn btn-info adicionar_remessa">Adicionar Remessa</button>

                                        <div id="novas_remessas"></div>

                                        <div id="<?= $this->registro['id']; ?>-1" class="remessa panel panel-default toggle" style="margin-bottom: 10px;">
                                            <div class="panel-heading min">
                                                <h4 class="panel-title">Remessa #<?= $this->registro['id']; ?>-1</h4>
                                                <input class="form-control hidden" name="remessa[<?= $this->registro['id']; ?>-1][id_pedido]" type="text" value="<?= $this->registro['id']; ?>"/>
                                                <input class="form-control hidden" name="remessa[<?= $this->registro['id']; ?>-1][id_status]" type="text" value="0"/>
                                                <input class="form-control hidden" name="remessa[<?= $this->registro['id']; ?>-1][titulo]" type="text" value="<?= $this->registro['id']; ?>-1"/>
                                                <input class="form-control hidden" name="remessa[<?= $this->registro['id']; ?>-1][entrega]" type="text" value="<?= $this->registro['prazo_entrega']; ?>"/>
                                            </div>
                                            <!-- Start .panel-body -->
                                            <!-- <div class="panel-body" style="display: none;"> -->
                                            <div class="panel-body">
                                                <div class="form-group">
                                                    <label class="col-lg-2 control-label" for="<?= $this->registro['id']; ?>-1-entrega">Entrega:</label>
                                                    <div class="col-lg-10">
                                                        <input class="form-control data_picker" id="<?= $this->registro['id']; ?>-1-entrega" name="remessa[<?= $this->registro['id']; ?>-1][nova_entrega]" type="text" value="" placeholder="<?= $this->registro['prazo_entrega']; ?>"/>
                                                        <p class="small_info_input">Apenas altere essa data caso necessário.</p>
                                                    </div>
                                                </div><!-- End .form-group  -->
    
                                                <div class="form-group">
                                                    <label class="col-lg-2 control-label" for="<?= $this->registro['id']; ?>-1-saida">Saída:</label>
                                                    <div class="col-lg-10">
                                                        <input class="form-control data_picker" id="<?= $this->registro['id']; ?>-1-saida" name="remessa[<?= $this->registro['id']; ?>-1][nova_saida]" type="text" value="" placeholder="A saída é definida pelos produtos"/>
                                                        <p class="small_info_input">Apenas altere essa data caso necessário.</p>
                                                    </div>
                                                </div><!-- End .form-group  -->
    
                                                <div class="form-group">
                                                    <label class="col-lg-2 control-label" for="<?= $this->registro['id']; ?>-1-n_nota">Nota:</label>
                                                    <div class="col-lg-10">
                                                        <input class="form-control" id="<?= $this->registro['id']; ?>-1-n_nota" name="remessa[<?= $this->registro['id']; ?>-1][n_nota]" type="text" value="<?= $this->registro['n_nota']; ?>" />
                                                    </div>
                                                </div><!-- End .form-group  -->

                                                <div class="form-group">
                                                    <label class="col-lg-2 control-label" for="<?= $this->registro['id']; ?>-1-nome">Cliente:</label>
                                                    <div class="col-lg-10">
                                                        <input class="form-control" id="<?= $this->registro['id']; ?>-1-nome" name="remessa[<?= $this->registro['id']; ?>-1][nome]" type="text" value="<?= $this->registro['cliente']; ?>" />
                                                    </div>
                                                </div><!-- End .form-group  -->

                                                <div class="form-group">
                                                    <label class="col-lg-2 control-label" for="<?= $this->registro['id']; ?>-1-telefone">Telefone:</label>
                                                    <div class="col-lg-10">
                                                        <input class="form-control" id="<?= $this->registro['id']; ?>-1-telefone" name="remessa[<?= $this->registro['id']; ?>-1][telefone]" type="text" value="<?= $this->registro['cliente_telefone']; ?>" />
                                                    </div>
                                                </div><!-- End .form-group  -->

                                                <div class="form-group">
                                                    <label class="col-lg-2 control-label" for="<?= $this->registro['id']; ?>-1-cpf_cnpj">CPF / CNPJ:</label>
                                                    <div class="col-lg-10">
                                                        <input class="form-control" id="<?= $this->registro['id']; ?>-1-cpf_cnpj" name="remessa[<?= $this->registro['id']; ?>-1][cpf_cnpj]" type="text" value="<?= $this->registro['cliente_cpf'] != '' ? $this->registro['cliente_cpf'] : $this->registro['cliente_cnpj']; ?>" />
                                                    </div>
                                                </div><!-- End .form-group  -->


                                                <!-- ENDEREÇO -->
                                                <div class="form-group">
                                                    <label class="col-lg-2 control-label" for="<?= $this->registro['id']; ?>-1-cep">CEP:</label>
                                                    <div class="col-lg-10">
                                                        <input class="form-control" name="remessa[<?= $this->registro['id']; ?>-1][cep]" id="<?= $this->registro['id']; ?>-1-cep" type="text" value="<?php echo $this->registro['cep']; ?>"/>
                                                    </div>
                                                </div><!-- End .form-group  -->

                                                <div class="form-group">
                                                    <label class="col-lg-2 control-label" for="<?= $this->registro['id']; ?>-1-endereco">Endereço:</label>
                                                    <div class="col-lg-10">
                                                        <input class="form-control" name="remessa[<?= $this->registro['id']; ?>-1][endereco]" id="<?= $this->registro['id']; ?>-1-endereco" type="text" value="<?php echo $this->registro['endereco']; ?>"/>
                                                    </div>
                                                </div><!-- End .form-group  -->

                                                <div class="form-group">
                                                    <label class="col-lg-2 control-label" for="<?= $this->registro['id']; ?>-1-numero">Número:</label>
                                                    <div class="col-lg-10">
                                                        <input class="form-control" name="remessa[<?= $this->registro['id']; ?>-1][numero]" id="<?= $this->registro['id']; ?>-1-numero" type="text" value="<?php echo $this->registro['numero']; ?>"/>
                                                    </div>
                                                </div><!-- End .form-group  -->

                                                <div class="form-group">
                                                    <label class="col-lg-2 control-label" for="<?= $this->registro['id']; ?>-1-bairro">Bairro:</label>
                                                    <div class="col-lg-10">
                                                        <input class="form-control" name="remessa[<?= $this->registro['id']; ?>-1][bairro]" id="<?= $this->registro['id']; ?>-1-bairro" type="text" value="<?php echo $this->registro['bairro']; ?>"/>
                                                    </div>
                                                </div><!-- End .form-group  -->

                                                <div class="form-group">
                                                    <label class="col-lg-2 control-label" for="<?= $this->registro['id']; ?>-1-complemento">Complemento:</label>
                                                    <div class="col-lg-10">
                                                        <input class="form-control" name="remessa[<?= $this->registro['id']; ?>-1][complemento]" id="<?= $this->registro['id']; ?>-1-complemento" type="text" value="<?php echo $this->registro['complemento']; ?>"/>
                                                    </div>
                                                </div><!-- End .form-group  -->

                                                <div class="form-group">
                                                    <label class="col-lg-2 control-label" for="<?= $this->registro['id']; ?>-1-estado">Estado:</label>
                                                    <div class="col-lg-10">
                                                        <select class="form-control input-sm getcidades" id="<?= $this->registro['id']; ?>-1-estado" name="remessa[<?= $this->registro['id']; ?>-1][id_estado]" data-auto-select-estado="<?php echo $this->registro['cliente_estado']; ?>" data-auto-select-cidade="<?php echo $this->registro['cliente_cidade']; ?>">
                                                            <option value="">Selecione..</option>
                                                            <?php foreach ($this->estados->rows as $estado) : ?>
                                                                <option data-uf="<?php echo $estado['uf'];?>" value="<?php echo $estado['id']; ?>"><?php echo $estado['estado']; ?></option>
                                                            <?php endforeach; ?>
                                                        </select>
                                                    </div>
                                                </div><!-- End .form-group  -->

                                                <div class="form-group">
                                                    <label class="col-lg-2 control-label" for="<?= $this->registro['id']; ?>-1-cidade">Cidade:</label>
                                                    <div class="col-lg-10">
                                                        <select class="form-control input-sm" id="<?= $this->registro['id']; ?>-1-cidade" name="remessa[<?= $this->registro['id']; ?>-1][id_cidade]">
                                                            <option value="">Selecione..</option>
                                                            <!-- Adicionado por javascript -->
                                                        </select>
                                                    </div>
                                                </div><!-- End .form-group  -->


                                            </div>
                                            <!-- End .panel-body -->
                                        </div>
                                    </div>

                                    <div class="panel panel-default toggle">
                                        <!-- Start .panel -->
                                        <div class="panel-heading">
                                            <h4 class="panel-title">Produtos</h4>
                                        </div>
                                        <div class="panel-body">
                                            <div class="form-group">
                                                <label class="col-lg-2 control-label" for="metodo_pagamento">Lista de produtos</label>
                                                <div class="col-lg-10 lista">
                                                    <ul style="margin: 0;">
                                                        <?php foreach ($produtos->rows as $produto) : ?>
                                                            <?php 
                                                                $qtd = 0;
                                                                if($produto['agrupavel'] == 0){
                                                                    $qtd = $produto['quantidade'];
                                                                } else {
                                                                    $qtd = 1;
                                                                }
                                                            ?>

                                                            <?php for ($i = 0; $i < $qtd; $i++) : ?>
                                                                <li>
                                                                    <p><?= $produto['nome_produto']; ?>
                                                                        <br>
                                                                        <span class="prazo">
                                                                            Prazo de produção: <?= $produto['prazo_producao'] + ($produto['prazo_producao_adic'] * $i); ?> dias
                                                                        </span>
                                                                        <?php if($produto['agrupavel'] == 1) : ?>
                                                                        <br>
                                                                        <span class="quantidade">
                                                                            Quantidade: <?= $produto['quantidade'] ?>
                                                                        </span>
                                                                        <?php endif; ?>
                                                                    </p>
                                                                    <input type="hidden" name="produto[<?= $produto['id']; ?>-<?= $i; ?>][id_carrinho_produto]" value="<?= $produto['id']; ?>" />
                                                                    <input type="hidden" name="produto[<?= $produto['id']; ?>-<?= $i; ?>][id_produto]" value="<?= $produto['id_produto']; ?>" />
                                                                    <input type="hidden" name="produto[<?= $produto['id']; ?>-<?= $i; ?>][id_categoria]" value="<?= $produto['id_categoria']; ?>" />
                                                                    <input type="hidden" name="produto[<?= $produto['id']; ?>-<?= $i; ?>][id_pedido]" value="<?= $produto['id_pedido']; ?>" />
                                                                    <input type="hidden" name="produto[<?= $produto['id']; ?>-<?= $i; ?>][nome_produto]" value="<?= $produto['nome_produto']; ?>" />
                                                                    <input type="hidden" name="produto[<?= $produto['id']; ?>-<?= $i; ?>][resumo]" value="<?= $produto['resumo']; ?>" />
                                                                    <input type="hidden" name="produto[<?= $produto['id']; ?>-<?= $i; ?>][nome_categoria]" value="<?= $produto['nome_categoria']; ?>" />
                                                                    <input type="hidden" name="produto[<?= $produto['id']; ?>-<?= $i; ?>][quantidade]" value="<?= $produto['quantidade']; ?>" />
                                                                    <input type="hidden" name="produto[<?= $produto['id']; ?>-<?= $i; ?>][observacao]" value="<?= $produto['observacao']; ?>" />
                                                                    <input type="hidden" name="produto[<?= $produto['id']; ?>-<?= $i; ?>][anexo]" value="<?= $produto['anexo']; ?>" />
                                                                    <input type="hidden" name="produto[<?= $produto['id']; ?>-<?= $i; ?>][foto_final]" value="<?= $produto['foto_final']; ?>" />
                                                                    <input type="hidden" name="produto[<?= $produto['id']; ?>-<?= $i; ?>][qtd_minima]" value="<?= $produto['qtd_minima'] ? $produto['qtd_minima'] : 0; ?>" />
                                                                    <input type="hidden" name="produto[<?= $produto['id']; ?>-<?= $i; ?>][agrupavel]" value="<?= $produto['agrupavel']; ?>" />
                                                                    <input type="hidden" name="produto[<?= $produto['id']; ?>-<?= $i; ?>][prazo_producao]" value="<?= $produto['prazo_producao'] + (($produto['prazo_producao_adic'] ? $produto['prazo_producao_adic'] : 0) * $i); ?>" />
                                                                    <input type="hidden" name="produto[<?= $produto['id']; ?>-<?= $i; ?>][prazo_producao_adic]" value="<?= $produto['prazo_producao_adic'] ? $produto['prazo_producao_adic'] : 0; ?>" />
                                                                    <select class="remessa_produto" name="produto[<?= $produto['id']; ?>-<?= $i; ?>][titulo_remessa]" id="produto-<?= $produto['id']; ?>-titulo_remessa">
                                                                        <option class="selecione_remessa" value="">Selecione a remessa</option>
                                                                        <option value="<?= $this->registro['id']; ?>-1" selected><?= $this->registro['id']; ?>-1</option>
                                                                        <?php foreach ($this->remessas_ativas as $remessa) : ?>
                                                                            <option value="<?= $remessa['titulo']; ?>"><?= $remessa['titulo']; ?></option>
                                                                        <?php endforeach; ?>
                                                                    </select>
                                                                </li>
                                                            <?php endfor; ?>
                                                        <?php endforeach;?>
                                                    </ul>
                                                    <span id="alert_titulo_remessa"></span>
                                                </div>
                                            </div><!-- End .form-group  -->
                                        </div>
                                    </div>
                                </div>
                            </div><!-- End .panel -->
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-success clickformProducao_">Enviar para produção</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="modal-mudar-remessa" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog" style="width:50vw; height:90vh;">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">
                            <span aria-hidden="true">&times;</span><span class="sr-only">Close</span>
                        </button>
                        <h4 class="modal-title" id="myModalLabel">Mudar remessa</h4>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-lg-12">
                                <form name="mudar_remessa_select" enctype="multipart/form-data" method="post" class="form-horizontal group-border">
                                    <input class="clickformMudarRemessaSelect" type="hidden" />

                                    <input class="form-control hidden id_ordem_select" name="id_ordem" type="text" value=""/>
                                    <input class="form-control hidden id_remessa_old_select" name="id_remessa_old" type="text" value=""/>

                                    <div class="panel panel-default">
                                        <!-- Start .panel -->
                                        <div class="panel-heading">
                                            <h4 class="panel-title">Remessas existentes</h4>
                                        </div>
                                        <div class="panel-body">
                                            <div class="form-group" style="padding-bottom: 0px;">
                                                <label class="col-lg-2 control-label" for="metodo_pagamento">Remessas:</label>
                                                <div class="col-lg-10">
                                                    <select name="remessa_id" class="form-control select_remessa">
                                                        <?php foreach($this->remessas_ativas as $remessa): ?>
                                                            <option value="<?= $remessa['id'] ?>"><?= $remessa['titulo'] ?></option>
                                                        <?php endforeach; ?>
                                                    </select>
                                                </div>
                                                <button type="button" class="btn btn-success clickformMudarRemessaSelect_" style="
                                                    margin: 45px 16px 0 auto;
                                                    display: block;">Selecionar remessa</button>
                                            </div><!-- End .form-group  -->
                                        </div>
                                    </div>
                                </form>
                                <form name="criar_mudar_remessa" enctype="multipart/form-data" method="post" class="form-horizontal group-border">
                                    <input class="clickformcriarMudarRemessa" type="hidden" />

                                    <input class="form-control hidden id_remessa_old" name="id_remessa_old" type="text" value=""/>
                                    <input class="form-control hidden id_ordem" name="id_ordem" type="text" value=""/>
                                    <input class="form-control hidden" name="id_pedido" type="text" value="<?= $this->registro['id']; ?>"/>
                                    <input class="form-control hidden" name="id_status" type="text" value="0"/>
                                    <input class="form-control hidden" name="titulo" type="text" value="<?= $this->nome_remessa_disponivel ?>"/>
                                    <input class="form-control hidden" name="entrega" type="text" value="<?= $this->registro['prazo_entrega']; ?>"/>
                                    <div class="panel panel-default toggle">
                                        <!-- Start .panel -->
                                        <div class="panel-heading">
                                            <h4 class="panel-title">Criar nova remessa</h4>
                                        </div>
                                        <div class="panel-body remessas_content" style="display: none;">
                                            <div class="form-group">
                                                <label class="col-lg-2 control-label" for="<?= $this->registro['id']; ?>-0-entrega">Entrega:</label>
                                                <div class="col-lg-10">
                                                    <input class="form-control data_picker" id="<?= $this->registro['id']; ?>-0-entrega" name="nova_entrega" type="text" value="" placeholder="<?= $this->registro['prazo_entrega']; ?>"/>
                                                    <p class="small_info_input">Apenas altere essa data caso necessário.</p>
                                                </div>
                                            </div><!-- End .form-group  -->

                                            <div class="form-group">
                                                <label class="col-lg-2 control-label" for="<?= $this->registro['id']; ?>-0-saida">Saída:</label>
                                                <div class="col-lg-10">
                                                    <input class="form-control data_picker" id="<?= $this->registro['id']; ?>-0-saida" name="nova_saida" type="text" value="" placeholder="A saída é definida pelos produtos"/>
                                                    <p class="small_info_input">Apenas altere essa data caso necessário.</p>
                                                </div>
                                            </div><!-- End .form-group  -->

                                            <div class="form-group">
                                                <label class="col-lg-2 control-label" for="<?= $this->registro['id']; ?>-0-n_nota">Nota:</label>
                                                <div class="col-lg-10">
                                                    <input class="form-control" id="<?= $this->registro['id']; ?>-0-n_nota" name="n_nota" type="text" value="<?= $this->registro['n_nota']; ?>" />
                                                </div>
                                            </div><!-- End .form-group  -->

                                            <div class="form-group">
                                                <label class="col-lg-2 control-label" for="<?= $this->registro['id']; ?>-0-nome">Cliente:</label>
                                                <div class="col-lg-10">
                                                    <input class="form-control" id="<?= $this->registro['id']; ?>-0-nome" name="nome" type="text" value="<?= $this->registro['cliente']; ?>" />
                                                </div>
                                            </div><!-- End .form-group  -->

                                            <div class="form-group">
                                                <label class="col-lg-2 control-label" for="<?= $this->registro['id']; ?>-0-telefone">Telefone:</label>
                                                <div class="col-lg-10">
                                                    <input class="form-control" id="<?= $this->registro['id']; ?>-0-telefone" name="telefone" type="text" value="<?= $this->registro['cliente_telefone']; ?>" />
                                                </div>
                                            </div><!-- End .form-group  -->

                                            <div class="form-group">
                                                <label class="col-lg-2 control-label" for="<?= $this->registro['id']; ?>-0-cpf_cnpj">CPF / CNPJ:</label>
                                                <div class="col-lg-10">
                                                    <input class="form-control" id="<?= $this->registro['id']; ?>-0-cpf_cnpj" name="cpf_cnpj" type="text" value="<?= $this->registro['cliente_cpf'] != '' ? $this->registro['cliente_cpf'] : $this->registro['cliente_cnpj']; ?>" />
                                                </div>
                                            </div><!-- End .form-group  -->


                                            <!-- ENDEREÇO -->
                                            <div class="form-group">
                                                <label class="col-lg-2 control-label" for="<?= $this->registro['id']; ?>-0-cep">CEP:</label>
                                                <div class="col-lg-10">
                                                    <input class="form-control" name="cep" id="<?= $this->registro['id']; ?>-0-cep" type="text" value="<?php echo $this->registro['cep']; ?>"/>
                                                </div>
                                            </div><!-- End .form-group  -->

                                            <div class="form-group">
                                                <label class="col-lg-2 control-label" for="<?= $this->registro['id']; ?>-0-endereco">Endereço:</label>
                                                <div class="col-lg-10">
                                                    <input class="form-control" name="endereco" id="<?= $this->registro['id']; ?>-0-endereco" type="text" value="<?php echo $this->registro['endereco']; ?>"/>
                                                </div>
                                            </div><!-- End .form-group  -->

                                            <div class="form-group">
                                                <label class="col-lg-2 control-label" for="<?= $this->registro['id']; ?>-0-numero">Número:</label>
                                                <div class="col-lg-10">
                                                    <input class="form-control" name="numero" id="<?= $this->registro['id']; ?>-0-numero" type="text" value="<?php echo $this->registro['numero']; ?>"/>
                                                </div>
                                            </div><!-- End .form-group  -->

                                            <div class="form-group">
                                                <label class="col-lg-2 control-label" for="<?= $this->registro['id']; ?>-0-bairro">Bairro:</label>
                                                <div class="col-lg-10">
                                                    <input class="form-control" name="bairro" id="<?= $this->registro['id']; ?>-0-bairro" type="text" value="<?php echo $this->registro['bairro']; ?>"/>
                                                </div>
                                            </div><!-- End .form-group  -->

                                            <div class="form-group">
                                                <label class="col-lg-2 control-label" for="<?= $this->registro['id']; ?>-0-complemento">Complemento:</label>
                                                <div class="col-lg-10">
                                                    <input class="form-control" name="complemento" id="<?= $this->registro['id']; ?>-0-complemento" type="text" value="<?php echo $this->registro['complemento']; ?>"/>
                                                </div>
                                            </div><!-- End .form-group  -->

                                            <div class="form-group">
                                                <label class="col-lg-2 control-label" for="<?= $this->registro['id']; ?>-0-estado">Estado:</label>
                                                <div class="col-lg-10">
                                                    <select class="form-control input-sm getcidades" id="<?= $this->registro['id']; ?>-0-estado" name="id_estado" data-auto-select-estado="<?php echo $this->registro['cliente_estado']; ?>" data-auto-select-cidade="<?php echo $this->registro['cliente_cidade']; ?>">
                                                        <option value="">Selecione..</option>
                                                        <?php foreach ($this->estados->rows as $estado) : ?>
                                                            <option data-uf="<?php echo $estado['uf'];?>" value="<?php echo $estado['id']; ?>"><?php echo $estado['estado']; ?></option>
                                                        <?php endforeach; ?>
                                                    </select>
                                                </div>
                                            </div><!-- End .form-group  -->

                                            <div class="form-group">
                                                <label class="col-lg-2 control-label" for="<?= $this->registro['id']; ?>-0-cidade">Cidade:</label>
                                                <div class="col-lg-10">
                                                    <select class="form-control input-sm" id="<?= $this->registro['id']; ?>-0-cidade" name="id_cidade">
                                                        <option value="">Selecione..</option>
                                                        <!-- Adicionado por javascript -->
                                                    </select>
                                                </div>
                                            </div><!-- End .form-group  -->
                                            <div class="form-group">

                                                <button type="button" class="btn btn-success clickformcriarMudarRemessa_" style="
                                                    margin: 45px 16px 0 auto;
                                                    display: block;">Criar remessa</button>
                                            </div><!-- End .form-group  -->
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div><!-- End .panel -->
                    </div>
                </div>
            </div>
        </div>
        
<?php  require_once "layouts/plugins.phtml"; ?>
        <script src="../../js/jquery.inputmask.bundle.min.js"></script>
        <script type="text/javascript" src="plugins/gallery/pretty-photo/jquery.prettyPhoto.js"></script>
        <!-- Init plugins only for page -->
        <script src="plugins/tables/dataTables/jquery.dataTables.js"></script>
        <script src="plugins/tables/dataTables/dataTables.tableTools.js"></script>
        <script src="plugins/tables/dataTables/dataTables.bootstrap.js"></script>
        <script src="plugins/tables/dataTables/dataTables.responsive.js"></script>
        <script src="plugins/forms/autosize/jquery.autosize.js"></script>
        <script src="plugins/ui/bootbox/bootbox.js"></script>
        <script src="js/jquery.form.js"></script>
        <script type="text/javascript">

            $('body').on('click', 'button.btn_fabricar', function () {
                $('#modal-fabricar').modal('show');
            });
            
            function moeda(z){  
                v = z.value;
                v=v.replace(/\D/g,"")  //permite digitar apenas números
                v=v.replace(/[0-9]{24}/,"inválido")   //limita pra máximo 999.999.999,99
                v=v.replace(/(\d{1})(\d{8})$/,"$1.$2")  //coloca ponto antes dos últimos 8 digitos
                v=v.replace(/(\d{1})(\d{5})$/,"$1.$2")  //coloca ponto antes dos últimos 5 digitos
                v=v.replace(/(\d{1})(\d{1,2})$/,"$1,$2")	//coloca virgula antes dos últimos 2 digitos
                z.value = v;
            }
            
            function mascara_num(obj){
                valida_num(obj)
                if (obj.value.match("-")){
                  mod = "-";
                }else{
                  mod = "";
                }
                valor = obj.value.replace("-","");
                valor = valor.replace(",","");
                if (valor.length >= 3){
                  valor = poe_ponto_num(valor.substring(0,valor.length-2))+","+valor.substring(valor.length-2, valor.length);
                }
                obj.value = mod+valor;
            }
            
            function poe_ponto_num(valor){
                valor = valor.replace(/\./g,"");
                if (valor.length > 3){
                  valores = "";
                  while (valor.length > 3){
                    valores = "."+valor.substring(valor.length-3,valor.length)+""+valores;
                    valor = valor.substring(0,valor.length-3);
                  }
                  return valor+""+valores;
                }else{
                  return valor;
                }
            }
            
            function valida_num(obj){
                numeros = new RegExp("[0-9]");
                while (!obj.value.charAt(obj.value.length-1).match(numeros)){
                  if(obj.value.length == 1 && obj.value == "-"){
                    return true;
                  }
                  if(obj.value.length >= 1){
                    obj.value = obj.value.substring(0,obj.value.length-1)
                  }else{
                    return false;
                  }
                }
            }

            function tempoEdicao(){
                var confirmar = false;

                //em 6 minutos solicitar usuário uma resposta sobre edição
                setTimeout(function(){
                    setTimeout(function(){

                        //se em 1 min não tiver confirmado, redirecionar para listagem dos pedidos
                        if(!confirmar){
                            window.location = "<?php echo $this->retorno; ?>";
                        }
                    },60000);

                    //perguntar se precisa de mais tempo pra editar o pedido
                    bootbox.confirm({
                        message: "Em um minuto esta janela irá se fechar e você irá perder os dados que ainda não foram salvo. Precisa de mais tempo para editar esse pedido?",
                        title: "Mais Tempo ?",
                        callback: function(result) {
                            if(result == false){
                                window.location = "<?php echo $this->retorno; ?>";
                            }
                        }
                    });
                },(6*60*1000));

            }
            function pretty(){
                $("a[rel^='prettyPhoto']").prettyPhoto({
                    default_width: 800,
                    default_height: 600,
                    theme: 'facebook',
                    social_tools: false,
                    show_title: false
                });
            };

            $(document).ready(function(){
                carregar_cidades('<?= $this->registro['id']; ?>-0');
                carregar_cidades('<?= $this->registro['id']; ?>-1');
                
                $('#<?= $this->registro['id']; ?>-1-cep').inputmask({'mask': '99.999-999'});
                $('#<?= $this->registro['id']; ?>-1-telefone').inputmask({'mask': '(99) 99999-9999'});
                $('#<?= $this->registro['id']; ?>-1-cep').on('keyup', () => preencherEndereco('<?= $this->registro['id']; ?>-1'));

                $('#<?= $this->registro['id']; ?>-0-cep').inputmask({'mask': '99.999-999'});
                $('#<?= $this->registro['id']; ?>-0-telefone').inputmask({'mask': '(99) 99999-9999'});
                $('#<?= $this->registro['id']; ?>-0-cep').on('keyup', () => preencherEndereco('<?= $this->registro['id']; ?>-0'));

                $(".data_picker").datepicker();
                let remessaIndex = 2;
                $('.adicionar_remessa').click(() => {
                    const baseId = '<?= $this->registro['id']; ?>';

                    // Garante que não exista id duplicado
                    let remessaId;
                    do {
                        remessaId = `${baseId}-${remessaIndex}`;
                        remessaIndex++;
                    } while ($(`#${remessaId}`).length);

                    const html = `
                        <div id="${remessaId}" class="remessa panel panel-default toggle" style="margin-bottom: 10px;">
                            <div class="panel-heading min">
                                <h4 class="panel-title">Remessa #${remessaId}</h4>
                                <button type="button" class="apagar_remessa"><span class="s16 brocco-icon-trashcan"></span></button>
                                <input class="form-control hidden" name="remessa[${remessaId}][id_pedido]" type="text" value="${baseId}" />
                                <input class="form-control hidden" name="remessa[${remessaId}][titulo]" type="text" value="${remessaId}" />
                                <input class="form-control hidden" name="remessa[${remessaId}][id_status]" type="text" value="0" />
                                <input class="form-control hidden" name="remessa[${remessaId}][entrega]" type="text" value="<?= $this->registro['prazo_entrega']; ?>" />
                            </div>
                            <div class="panel-body">
                                <div class="form-group">
                                    <label class="col-lg-2 control-label" for="${remessaId}-entrega">Entrega:</label>
                                    <div class="col-lg-10">
                                        <input class="form-control data_picker" id="${remessaId}-entrega" name="remessa[${remessaId}][nova_entrega]" type="text" value="" placeholder="<?= $this->registro['prazo_entrega']; ?>" />
                                        <p class="small_info_input">Apenas altere essa data caso necessário.</p>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-lg-2 control-label" for="${remessaId}-saida">Saída:</label>
                                    <div class="col-lg-10">
                                        <input class="form-control data_picker" id="${remessaId}-saida" name="remessa[${remessaId}][nova_saida]" type="text" placeholder="A saída é definida pelos produtos"/>
                                        <p class="small_info_input">Apenas altere essa data caso necessário.</p>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-lg-2 control-label" for="${remessaId}-n_nota">Nota:</label>
                                    <div class="col-lg-10">
                                        <input class="form-control" id="${remessaId}-n_nota" name="remessa[${remessaId}][n_nota]" type="text" value="<?= $this->registro['n_nota']; ?>" />
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-lg-2 control-label" for="${remessaId}-nome">Cliente:</label>
                                    <div class="col-lg-10">
                                        <input class="form-control" id="${remessaId}-nome" name="remessa[${remessaId}][nome]" type="text" value="<?= $this->registro['cliente']; ?>" />
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-lg-2 control-label" for="${remessaId}-telefone">Telefone:</label>
                                    <div class="col-lg-10">
                                        <input class="form-control" id="${remessaId}-telefone" name="remessa[${remessaId}][telefone]" type="text" value="<?= $this->registro['cliente_telefone']; ?>" />
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-lg-2 control-label" for="${remessaId}-cpf_cnpj">CPF / CNPJ:</label>
                                    <div class="col-lg-10">
                                        <input class="form-control" id="${remessaId}-cpf_cnpj" name="remessa[${remessaId}][cpf_cnpj]" type="text" value="<?= $this->registro['cliente_cpf'] != '' ? $this->registro['cliente_cpf'] : $this->registro['cliente_cnpj']; ?>" />
                                    </div>
                                </div>

                                <!-- ENDEREÇO -->
                                <div class="form-group">
                                    <label class="col-lg-2 control-label" for="${remessaId}-cep">CEP:</label>
                                    <div class="col-lg-10">
                                        <input class="form-control" name="remessa[${remessaId}][cep]" id="${remessaId}-cep" type="text" value="<?php echo $this->registro['cep']; ?>"/>
                                    </div>
                                </div><!-- End .form-group  -->

                                <div class="form-group">
                                    <label class="col-lg-2 control-label" for="${remessaId}-endereco">Endereço:</label>
                                    <div class="col-lg-10">
                                        <input class="form-control" name="remessa[${remessaId}][endereco]" id="${remessaId}-endereco" type="text" value="<?php echo $this->registro['endereco']; ?>"/>
                                    </div>
                                </div><!-- End .form-group  -->

                                <div class="form-group">
                                    <label class="col-lg-2 control-label" for="${remessaId}-numero">Número:</label>
                                    <div class="col-lg-10">
                                        <input class="form-control" name="remessa[${remessaId}][numero]" id="${remessaId}-numero" type="text" value="<?php echo $this->registro['numero']; ?>"/>
                                    </div>
                                </div><!-- End .form-group  -->

                                <div class="form-group">
                                    <label class="col-lg-2 control-label" for="${remessaId}-bairro">Bairro:</label>
                                    <div class="col-lg-10">
                                        <input class="form-control" name="remessa[${remessaId}][bairro]" id="${remessaId}-bairro" type="text" value="<?php echo $this->registro['bairro']; ?>"/>
                                    </div>
                                </div><!-- End .form-group  -->

                                <div class="form-group">
                                    <label class="col-lg-2 control-label" for="${remessaId}-complemento">Complemento:</label>
                                    <div class="col-lg-10">
                                        <input class="form-control" name="remessa[${remessaId}][complemento]" id="${remessaId}-complemento" type="text" value="<?php echo $this->registro['complemento']; ?>"/>
                                    </div>
                                </div><!-- End .form-group  -->

                                <div class="form-group">
                                    <label class="col-lg-2 control-label" for="${remessaId}-estado">Estado:</label>
                                    <div class="col-lg-10">
                                        <select class="form-control input-sm getcidades" id="${remessaId}-estado" name="remessa[${remessaId}][id_estado]" data-auto-select-estado="<?php echo $this->registro['cliente_estado']; ?>" data-auto-select-cidade="<?php echo $this->registro['cliente_cidade']; ?>">
                                            <option value="">Selecione..</option>
                                            <?php foreach ($this->estados->rows as $estado) : ?>
                                                <option data-uf="<?php echo $estado['uf'];?>" value="<?php echo $estado['id']; ?>"><?php echo $estado['estado']; ?></option>
                                            <?php endforeach; ?>
                                        </select>
                                    </div>
                                </div><!-- End .form-group  -->

                                <div class="form-group">
                                    <label class="col-lg-2 control-label" for="${remessaId}-cidade">Cidade:</label>
                                    <div class="col-lg-10">
                                        <select class="form-control input-sm" id="${remessaId}-cidade" name="remessa[${remessaId}][id_cidade]">
                                            <option value="">Selecione..</option>
                                            <!-- Adicionado por javascript -->
                                        </select>
                                    </div>
                                </div><!-- End .form-group  -->

                            </div>
                        </div>
                    `;

                    $('#novas_remessas').prepend(html);
                    $(".data_picker").datepicker();

                    const option = `<option value="${remessaId}">${remessaId}</option>`;
                    $('.remessa_produto').each(function () {
                        const principal = $(this).find('option.selecione_remessa');
                        if (principal.length) {
                            $(option).insertAfter(principal);
                        } else {
                            $(this).append(option);
                        }
                    });

                    carregar_cidades(remessaId);
                    $(`#${remessaId}-telefone`).inputmask({'mask': '(99) 99999-9999'});
                    $(`#${remessaId}-cep`).inputmask({'mask': '99.999-999'});
                    $(`#${remessaId}-cep`).on('keyup', () => preencherEndereco(remessaId));
                });

                $('#novas_remessas').on('click', '.apagar_remessa', function () {
                    const remessaEl = $(this).closest('.remessa');
                    const remessaId = remessaEl.attr('id');

                    remessaEl.remove();

                    $('.remessa_produto option').each(function () {
                        if ($(this).val() === remessaId) {
                            $(this).remove();
                        }
                    });
                });

                pretty();

                <?php if($this->editor_permission): ?>
                    tempoEdicao();

                    //PING A CADA 45 SEGUNDOS
                    setInterval(function(){
                        $.post("<?php echo $this->getModule();?>/ping",{id:<?php echo $this->id ?>});
                    },45000);

                <?php else: ?>
                    <?php if(!isset($this->read)): ?>
                        //PONG A CADA 45 SEGUNDOS
                        setInterval(function(){
                            $.post("<?php echo $this->getModule();?>/pOng",{id:<?php echo $this->id ?>}, function(data){
                                if(data == 1){
                                    window.location.reload();
                                }
                            });
                        },45000);
                    <?php endif ?>
                <?php endif; ?>
                
                $(document).on("keyup blur", ".deducao_valor", function(){
                    mascara_num(this);
                });
                
                $(document).on("keyup blur", "#valor_fabrica", function(){
                    mascara_num(this);
                });
                
                
                $(document).on("keyup blur", ".vf_", function(){
                    mascara_num(this);
                });

                $(document).on("keyup blur", "#custo_frete", function(){
                    mascara_num(this);
                });

                $(document).on("focus", "#custo_frete", function(){
                    $(this).select();
                });
                
                
                $('.elastic').autosize();
                $("#cep").mask("#####-###");               


                //upload documento do cliente
                $(document).on("change", ".anexo_documentos", function() {
                    var base = $(this).parents(".doc_container");
                    var id = <?php echo $this->id; ?>;
                    var file_data = $(this).prop('files')[0];
                    var anexoFile = base.find(".doc_file");
                    
                    var form_data = new FormData();
                    form_data.append($(this).attr('name'), file_data);
                    form_data.append('id', id);
                    form_data.append('documento_padrao', $("#documento_padrao").val());
                    
                    $.gritter.add({
                        title: 'Aguarde !!!',
                        text: "O arquivo está sendo enviado !!!",
                        time: '',
                        close_icon: 'entypo-icon-cancel s12',
                        icon: 'icomoon-icon-checkmark-3 ',
                        class_name: 'warning-notice'
                    });
                    
                    
                    $.ajax({
                        url: "<?php echo $this->getModule();?>/uploadDocumentos", // point to server-side PHP script 
                        dataType: 'json',  // what to expect back from the PHP script, if anything
                        cache: false,
                        contentType: false,
                        processData: false,
                        data: form_data,                         
                        type: 'post',
                        success: function(dt){
                            if (dt.type == "success") {
                                $.gritter.add({
                                    title: 'Pronto !!!',
                                    text: dt.message,
                                    time: '',
                                    close_icon: 'entypo-icon-cancel s12',
                                    icon: 'icomoon-icon-checkmark-3 ',
                                    class_name: 'success-notice'
                                });
                                if(dt.arquivo_tipo == "pdf"){
                                    anexoFile.empty().append("<br><a href='"+dt.arquivo_link+"'' target='_blank'>Abrir Documento PDF.</a><br><br>");
                                }else{
                                    anexoFile.empty().append("<a href='"+dt.arquivo_link+"'' rel='prettyPhoto' title='Cartão Frente'><img src='"+dt.foto+"'' alt='' class='image doc_image marginR10'/></a>");
                                    pretty();
                                }
                                //anexoFile.attr('src',dt.arquivo);
                                //$("#documento_padrao").val(dt.id_padrao);
                            } else {
                                $.gritter.add({
                                    title: 'Erro !!!',
                                    text: dt.message,
                                    time: '',
                                    close_icon: 'entypo-icon-cancel s12',
                                    icon: 'cut-icon-alert  ',
                                    class_name: 'error-notice'
                                });  
                            }
                        }, complete: function (dt) {
                            $(".btn-salvar-hide-atributo").addClass("btn-salvar-atributo");
                            $(".btn-salvar-atributo").removeClass("btn-salvar-hide-atributo");
                        }
                     });
                });

                //upload imagem do produto finalizado
                $(document).on("change", ".anexo_foto_final", function() {
                    var base = $(this).parents(".identificacao_foto");
                    var id = $(this).attr("data-id");
                    var file_data = $(this).prop('files')[0];
                    var anexoFile = base.find(".img_foto_final");
                    
                    var form_data = new FormData();                  
                    form_data.append('foto_final', file_data);
                    form_data.append('id', id);
                    
                    $.gritter.add({
                        title: 'Aguarde !!!',
                        text: "O arquivo está sendo enviado !!!",
                        time: '',
                        close_icon: 'entypo-icon-cancel s12',
                        icon: 'icomoon-icon-checkmark-3 ',
                        class_name: 'warning-notice'
                    });
                    
                    
                    $.ajax({
                        url: "<?php echo $this->getModule();?>/uploadFoto", // point to server-side PHP script 
                        dataType: 'json',  // what to expect back from the PHP script, if anything
                        cache: false,
                        contentType: false,
                        processData: false,
                        data: form_data,                         
                        type: 'post',
                        success: function(dt){
                            if (dt.type == "success") {
                                $.gritter.add({
                                    title: 'Pronto !!!',
                                    text: dt.message,
                                    time: '',
                                    close_icon: 'entypo-icon-cancel s12',
                                    icon: 'icomoon-icon-checkmark-3 ',
                                    class_name: 'success-notice'
                                });
                                anexoFile.attr('src',dt.arquivo);
                            } else {
                                $.gritter.add({
                                    title: 'Erro !!!',
                                    text: dt.message,
                                    time: '',
                                    close_icon: 'entypo-icon-cancel s12',
                                    icon: 'cut-icon-alert  ',
                                    class_name: 'error-notice'
                                });  
                            }
                        }, complete: function (dt) {
                            $(".btn-salvar-hide-atributo").addClass("btn-salvar-atributo");
                            $(".btn-salvar-atributo").removeClass("btn-salvar-hide-atributo");
                        }
                     });
                });
                
                //upload imagem de atributo
                $(document).on("change", ".anexo", function() {
                    var base = $(this).parents(".produtos");
                    var id_produto_historico = $(this).attr("data-id");
                    var file_data = $(this).prop('files')[0];
                    var anexoFile = base.find(".anexo-file:first");
                    
                    var form_data = new FormData();                  
                    form_data.append('arquivo', file_data);
                    form_data.append('id_produto_historico', id_produto_historico);
                    
                    $.gritter.add({
                        title: 'Aguarde !!!',
                        text: "O arquivo está sendo enviado !!!",
                        time: '',
                        close_icon: 'entypo-icon-cancel s12',
                        icon: 'icomoon-icon-checkmark-3 ',
                        class_name: 'warning-notice'
                    });
                    
                    
                    $.ajax({
                        url: "<?php echo $this->getModule();?>/uploadFile", // point to server-side PHP script 
                        dataType: 'json',  // what to expect back from the PHP script, if anything
                        cache: false,
                        contentType: false,
                        processData: false,
                        data: form_data,                         
                        type: 'post',
                        success: function(dt){
                            if (dt.type == "success") {
                                $.gritter.add({
                                    title: 'Pronto !!!',
                                    text: dt.message,
                                    time: '',
                                    close_icon: 'entypo-icon-cancel s12',
                                    icon: 'icomoon-icon-checkmark-3 ',
                                    class_name: 'success-notice'
                                });
                                anexoFile.html('<a style="padding: 10px 0" href="' + dt.arquivo + '" download>Anexo</a> <a style="padding: 10px 0" data-id="' + id_produto_historico + '" class="remove-anexo s12 icomoon-icon-cancel-circle-2 pointer"></a>');
                            } else {
                                $.gritter.add({
                                    title: 'Erro !!!',
                                    text: dt.message,
                                    time: '',
                                    close_icon: 'entypo-icon-cancel s12',
                                    icon: 'cut-icon-alert  ',
                                    class_name: 'error-notice'
                                });  
                            }
                        }, complete: function (dt) {
                            $(".btn-salvar-hide-atributo").addClass("btn-salvar-atributo");
                            $(".btn-salvar-atributo").removeClass("btn-salvar-hide-atributo");
                        }
                     });
                });
                
                //apagar imagem
                $(document).on("click", ".remove-anexo", function(){
                    var base = $(this).parents(".produtos");
                    var id_produto_historico = $(this).attr("data-id");
                    var anexoFile = base.find(".anexo-file:first");
                    bootbox.confirm({
                        message: "Deseja realmente remover o anexo ?",
                        title: "Atenção!!!",
                        className: "modal-style1",
                        callback: function (result) {
                            if (result) {
                                $.post("<?php echo $this->getModule(); ?>/delArquivo", 
                                    { 
                                        id_produto_historico: id_produto_historico

                                    }, function( dt ) {

                                }, "json").done(function(dt){
                                    if (dt.type == "success") {
                                        $.gritter.add({
                                            title: 'Pronto !!!',
                                            text: dt.message,
                                            time: '',
                                            close_icon: 'entypo-icon-cancel s12',
                                            icon: 'icomoon-icon-checkmark-3 ',
                                            class_name: 'success-notice'
                                        });
                                        anexoFile.html("");
                                    } else if ((dt.type == "error")) {
                                        $.gritter.add({
                                            title: 'Erro !!!',
                                            text: dt.message,
                                            time: '',
                                            close_icon: 'entypo-icon-cancel s12',
                                            icon: 'cut-icon-alert  ',
                                            class_name: 'error-notice'
                                        });
                                    }
                                });
                            }
                        }
                    });
                    
                });
                
                //--------------- Data tables ------------------//
                if($('table').hasClass('tabletools')){
                    $('.tabletools').dataTable( {
                        "oLanguage": {
                            "sSearch": "",
                            "sLengthMenu": "<span>_MENU_</span>",
                            "sProcessing":   "Processando...",                    
                            "sZeroRecords":  "Não foram encontrados resultados",
                            "sInfo":         "Mostrando de _START_ até _END_ de _TOTAL_ registros",
                            "sInfoEmpty":    "Mostrando de 0 até 0 de 0 registros",
                            "sInfoFiltered": "(filtrado de _MAX_ registros no total)",
                            "sInfoPostFix":  "",
                            "sUrl":         "",

                            "oPaginate": {
                                "sFirst":    "Primeiro",
                                "sPrevious": "Anterior",
                                "sNext":     "Seguinte",
                                "sLast":     "Último"
                            }
                        },
                        "sDom": "T<'row'<'col-md-6 col-xs-12 'l><'col-md-6 col-xs-12'f>r>t<'row'<'col-md-4 col-xs-12'i><'col-md-8 col-xs-12'p>>",
                        "aaSorting":[[0,"desc"]],
                        tableTools: {
                            "sSwfPath": "http://cdn.datatables.net/tabletools/2.2.2/swf/copy_csv_xls_pdf.swf",
                            "aButtons": [
                          ]
                        }


                    });

                }

                
                $('.data').mask('00/00/0000');
                $(".data").datepicker({
                    dateFormat: 'dd/mm/yy',
                    dayNames: ['Domingo','Segunda','Terça','Quarta','Quinta','Sexta','Sábado'],
                    dayNamesMin: ['D','S','T','Q','Q','S','S','D'],
                    dayNamesShort: ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb','Dom'],
                    monthNames: ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'],
                    monthNamesShort: ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'],
                    nextText: 'Próximo',
                    prevText: 'Anterior'
                });

                $('#data_competencia').mask('00/00/0000');
                $("#data_competencia").datepicker({
                    dateFormat: 'dd/mm/yy',
                    dayNames: ['Domingo','Segunda','Terça','Quarta','Quinta','Sexta','Sábado'],
                    dayNamesMin: ['D','S','T','Q','Q','S','S','D'],
                    dayNamesShort: ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb','Dom'],
                    monthNames: ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'],
                    monthNamesShort: ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'],
                    nextText: 'Próximo',
                    prevText: 'Anterior'
                });
                $('#data_saida').mask('00/00/0000');
                $("#data_saida").datepicker({
                    dateFormat: 'dd/mm/yy',
                    dayNames: ['Domingo','Segunda','Terça','Quarta','Quinta','Sexta','Sábado'],
                    dayNamesMin: ['D','S','T','Q','Q','S','S','D'],
                    dayNamesShort: ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb','Dom'],
                    monthNames: ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'],
                    monthNamesShort: ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'],
                    nextText: 'Próximo',
                    prevText: 'Anterior'
                });
                $('#data_entrega').mask('00/00/0000');
                $("#data_entrega").datepicker({
                    dateFormat: 'dd/mm/yy',
                    dayNames: ['Domingo','Segunda','Terça','Quarta','Quinta','Sexta','Sábado'],
                    dayNamesMin: ['D','S','T','Q','Q','S','S','D'],
                    dayNamesShort: ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb','Dom'],
                    monthNames: ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'],
                    monthNamesShort: ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'],
                    nextText: 'Próximo',
                    prevText: 'Anterior'
                });

                
                var countRastreios = "<?php echo $this->rastreios->num_rows;?>";
                
                $(document).on("click",".btn-plus",function(e){
                    e.preventDefault();
                    $.post("<?php echo $this->getModule();?>/getRastreioTemplate", {  }, function( data ) {
                        countRastreios++;
                        $("#rastreios").append(data);
                    });
                   
                });
                
                $(document).on("click", ".btn-minus", function(){
                    var base = $(this).parents(".node");
                     if (countRastreios > 1) {
                        var message = "Deseja realmente remover este campo? Se sim, clique em Ok.";
                    } else {
                        var message = "Deseja realmente limpar este campo? Se sim, clique em Ok.";
                    }
                    bootbox.confirm({
                        message: message,
                        title: "Atenção!!!",
                        className: "modal-style1",
                        callback: function (result) {
                            if (result) {
                                if (countRastreios > 1) {
                                    base.remove();
                                    countRastreios--;
                                } else {
                                    $(".link").val("");
                                    $(".descricao").val("");
                                    $(".rastreio_msg").val("Despachar");
                                    $(".rastreio_stats").val(0);
                                }
                            }
                        }
                    });
                    
                });

                $(document).on("change", "#id_estado", function (){
                    var id = $(this).val();
                    $("#id_cidade").load("<?php echo $this->getModule();?>/cidades/?id=" + id + "&cidade=" + <?php echo $endereco->rows[0]['id_cidade'];?>, function () {

                    });
                });
                
                $("#id_estado").trigger("change");
                
                var contNotificacao = 1;
                var notificacaoId = 1;
                var nmore = 500;
                
                $(document).on("click",".btn-plus-notificacao",function(e){
                    e.preventDefault();
                    $.post("<?php echo $this->getModule();?>/getNotificacaoTemplate", { id : notificacaoId, idmore:nmore, id_pedido: "<?php  echo $this->id;?>"  }, function( data ) {
                        contNotificacao++;
                        notificacaoId++;
                        nmore++;
                        $("#notificacoes").append(data);
                    }).done(function(){
                        $('.elastic').autosize();
                        uniform();
                    });
                   
                });
                
                
                //enviar notificações
                $(document).on("click", ".btn-send-email", function(){
                    
                    var data = $("form").serialize();
                    
                    var src = 'images/loaders/circular/027.gif';
                    $(".btn-send-email").after("<span class='loading'><img src='"+src+"'/></span>");
                                        
                    $.post("<?php echo $this->getModule(); ?>/sendNotifications",
                        { 
                            data: data
                            
                        }, function( dt ) {
                        
                    }, "json").done(function(dt){
                        $(".loading").remove();
                        if (dt.status) {
                            $.gritter.add({
                                title: 'Pronto !!!',
                                text: dt.message,
                                time: '',
                                close_icon: 'entypo-icon-cancel s12',
                                icon: 'icomoon-icon-checkmark-3 ',
                                class_name: 'success-notice'
                            });
                        } else {
                            $.gritter.add({
                                title: 'Erro !!!',
                                text: dt.message,
                                time: '',
                                close_icon: 'entypo-icon-cancel s12',
                                icon: 'cut-icon-alert  ',
                                class_name: 'error-notice'
                            });
                        }
                    });
                    
                   
                });
                
                
                var sendmsg = true;
                
                $(document).on("click",".btn-save-observacao", function(){
                    var base = $(this).parents('.node');
                    var id = $(this).attr('data-id');
                    var id_pedido = $(this).attr('data-id-pedido');
                    var observacao = base.find(".observacao").val();
                    $.post("<?php echo $this->getModule(); ?>/sendObservacao",
                        { 
                            id_pedido : id_pedido,
                            id : id,
                            observacao :observacao
                            
                        }, function( dt ) {
                        
                    }, "json").done(function(dt){
                        $("#loading").remove();
                        if (dt.type == "success" && sendmsg) {
                            $.gritter.add({
                                title: 'Pronto !!!',
                                text: dt.message,
                                time: '',
                                close_icon: 'entypo-icon-cancel s12',
                                icon: 'icomoon-icon-checkmark-3 ',
                                class_name: 'success-notice'
                            });
                        } else if(dt.type == "error" && sendmsg) {
                            $.gritter.add({
                                title: 'Erro !!!',
                                text: dt.message,
                                time: '',
                                close_icon: 'entypo-icon-cancel s12',
                                icon: 'cut-icon-alert  ',
                                class_name: 'error-notice'
                            });
                        }
                    });
                });

                $(document).on("click",".btn-avaliacao", function(){
                    var id_avaliacao = $(this).attr('data-id-avaliacao');
                    if(id_avaliacao == ""){
                        var id_produto = $(this).attr('data-id-produto');
                        var id_pedido = $(this).attr('data-id-pedido');
                        window.open("productreview/edit/id_produto/"+id_produto+"/id_pedido/"+id_pedido);
                    }else{
                        window.open("productreview/edit/id/"+id_avaliacao+"/id_produto/");
                    }
                });
                
                $(document).on("click", ".btn-faturar", function(){
                    //$(".btn-faturar").hide();
                    $.post("<?php echo $this->getModule();?>/createBlingInvoice", { id: "<?php echo $this->id;?>", emitente: $(this).data('emitente') }, function( data ) {
                        if (data.type == "success") {
                            
                            $("#n_nota").val(data.numero);
                            $("#idNotaFiscal").val(data.idNotaFiscal);
                            
                            $(".btn-faturar").hide();
                            
                            uniform();
                            
                            $.gritter.add({
                                title: 'Pronto !!!',
                                text: data.message,
                                time: '',
                                close_icon: 'entypo-icon-cancel s12',
                                icon: 'icomoon-icon-checkmark-3 ',
                                class_name: 'success-notice'
                            });
                        } else if(data.type == "error") {
                            $.gritter.add({
                                title: 'Erro !!!',
                                text: data.message,
                                time: '',
                                close_icon: 'entypo-icon-cancel s12',
                                icon: 'cut-icon-alert  ',
                                class_name: 'error-notice'
                            });
                            
                            $(".btn-faturar").show();
                        }
                    }, "json");
                });
                
                $(document).on("click", ".btn-send-nota", function () {
                    var nota = $("#n_nota").val();

                    if (nota != "") {

                        $.post("<?php echo $this->getModule(); ?>/sendNota", {nota: nota, id_cliente: "<?php echo $this->registro['id_cliente'];?>"}, function (data) {
                            if (data.type == "success") {
                                $.gritter.add({
                                    title: 'Pronto !!!',
                                    text: data.message,
                                    time: '',
                                    close_icon: 'entypo-icon-cancel s12',
                                    icon: 'icomoon-icon-checkmark-3 ',
                                    class_name: 'success-notice'
                                });
                            } else if (data.type == "error") {
                                $.gritter.add({
                                    title: 'Erro !!!',
                                    text: data.message,
                                    time: '',
                                    close_icon: 'entypo-icon-cancel s12',
                                    icon: 'cut-icon-alert  ',
                                    class_name: 'error-notice'
                                });
                            }
                        }, "json");

                    } else {
                        $.gritter.add({
                            title: 'Erro !!!',
                            text: "Antes de enviar, por favor, fature a Nota clicando em (Faturar) !!!",
                            time: '',
                            close_icon: 'entypo-icon-cancel s12',
                            icon: 'cut-icon-alert  ',
                            class_name: 'error-notice'
                        });
                    }

                });
                
                
                $(document).on("click",".btn-plus-deducao",function(e){
                    e.preventDefault();
                    var base = $(this).parents(".deducoes").find(".adicao");
                    $.post("<?php echo $this->getModule();?>/getDeducaoTemplate", {  }, function( data ) {
                        base.before(data);
                    });
                   
                });
                
                $(document).on("click", ".btn-minus-deducao", function(){
                    var base =  $(this).parents(".deducoes");
                    var countDeducoes = base.find(".deducao_valor").length;
                    var linha = $(this).parents(".node");
                    var dv = base.find(".deducao_valor");
                    
                    if (countDeducoes > 1)
                        var message = "Deseja realmente remover este registro? Se sim, clique em Ok.";
                    else 
                        var message = "Deseja realmente limpar este registro? Se sim, clique em Ok.";
                    
                    bootbox.confirm({
                        message: message,
                        title: "Atenção!!!",
                        className: "modal-style1",
                        callback: function (result) {
                            if (result) {
                                if (countDeducoes > 1) {
                                    linha.remove();
                                } else {
                                  linha.find(".deducao_descricao").val("");
                                  linha.find(".deducao_valor").val("");
                                }
                                dv.trigger("blur");
                            }
                        }
                    });
                    
                });
                
                $(document).on("click", ".btn-salvar-deducao", function(){                    
                    var base = $(this).parents(".deducoes");
                    var id_produto = $(this).attr("data-id-produto");
                    
                    var descricao = [];
                    var valor = [];
                    
                    base.find('.deducao_descricao').each(function () {
                        descricao.push($(this).val());
                    });
                    
                    base.find('.deducao_valor').each(function () {
                        valor.push($(this).val());
                    });
                    
                    $.post("<?php echo $this->getModule(); ?>/saveDeducoes", {id_pedido: "<?php echo $this->id;?>",id: id_produto,descricoes:descricao,valores:valor}, function (data) {
                        if (data.type == "success" && sendmsg) {
                            $.gritter.add({
                                title: 'Pronto !!!',
                                text: data.message,
                                time: '',
                                close_icon: 'entypo-icon-cancel s12',
                                icon: 'icomoon-icon-checkmark-3 ',
                                class_name: 'success-notice'
                            });
                        } else if (data.type == "error" && sendmsg) {
                            $.gritter.add({
                                title: 'Erro !!!',
                                text: data.message,
                                time: '',
                                close_icon: 'entypo-icon-cancel s12',
                                icon: 'cut-icon-alert  ',
                                class_name: 'error-notice'
                            });
                        }
                    }, "json");
                });


                $('.contaazul_submit').click(function(){
                    $('[name=pedido_valor_total]').val($('#valor_final_ca').val());
                    //alert($('[name=pedido_valor_total]').val());
                    $('.contaazul_submit_official').trigger('click');
                });

                $("form[name=savecontaazul]").clickform({"validateUrl": "<?php echo $this->getModule(); ?>/contaazul/<?php echo $this->registro['id'] ?>", 'submitButton': '.contaazul_submit_official', 'activateEnterKey' : false, 'clearFields': false});

                
                var continuar = false;
                $("form[name=order]").clickform({"validateUrl": controller, 'submitButton': '.clickformsubmit', 'blockScroll': true, 'activateEnterKey' : false, 'clearFields': false}, function (data) {
                    if (!continuar && data.type == "success") {
                        window.location.href = retorno;
                    }
                    continuar = false;
                });

                $('.btn_continuar').click(function(){
                    continuar = true;
                    $('.clickformsubmit_:first').trigger('click');
                });
                
                $(document).on("click",".clickformsubmit_", function(){
                    sendmsg = false;
                    $(".btn-save-observacao").trigger("click");
                    $(".btn-salvar-deducao").trigger("click");
                    $(".clickformsubmit").trigger("click");
                });

                // Carrega a tabela por AJAX
                var obsTable = $('#observacoes').dataTable({
                    bProcessing: true,
                    bServerSide: true,
                    sAjaxSource: `${pagina}/obs`,
                    sServerMethod: 'POST',
                    fnServerParams: function(aoData) {
                        aoData.push({ name: 'id_pedido', value: <?php echo $this->registro['id']; ?> });
                    },

                    aoColumns: [
                        {
                            sTitle: 'Ações',
                            sClass: 'per5 obs-acoes',
                            bSortable: false,
                            mData: 'id',
                            mRender: function(mData) {
                                return (mData) ? `<i class="s12 icomoon-icon-remove obs_submit" data-id="${mData}" data-action="del"></i>` : '';
                            }
                        },
                        {
                            sTitle: 'Data',
                            sClass: 'tal per10',
                            bSortable: false,
                            mData: 'data'
                        },
                        {
                            sTitle: 'Categorias',
                            sClass: 'tal per15',
                            bSortable: false,
                            mData: 'categoria',
                            mRender: function(mData) {
                                var categorias = [
                                    { label: 'Financeiro', cor: '#FFED00' },
                                    { label: 'Transporte', cor: '#00B019' },
                                    { label: 'Gerais', cor: '#002BC6' },
                                    { label: 'Atenção', cor: '#FF4200' }
                                ];
                                if (mData) {
                                    var c = categorias.find(function(el) { return el.label === mData; })
                                    return `<div style="padding-left:5px;border-left:7px solid ${c.cor}">${c.label}</div>`
                                };

                                // Lista de categorias da nova observação (localmente adicionado)
                                var opts = categorias.map(function(c) {
                                    return `<option val="${c.label}"><div style="padding-left:5px;border-left:7px solid ${c.cor}">${c.label}</div></option>`;
                                });
                                return `<select class="form-control">${opts.join('')}</select>`;
                            }
                        },
                        {
                            sTitle: 'Observação',
                            sClass: 'tal per50',
                            bSortable: false,
                            mData: 'texto',
                            mRender: function(mData) {
                                if (mData) return mData;
                                // Texto da nova observação (localmente adicionado)
                                return `
                                    <textarea class="form-control"></textarea>
                                    <br />
                                    <a data-action="new" class="btn btn-success obs_submit" href="#">Adicionar</a>
                                `;
                            }
                        },
                        {
                            sTitle: 'Criado por',
                            sClass: 'tal per10',
                            bSortable: false,
                            mData: 'criado_por',
                        },
                        {
                            sTitle: 'Deletado por',
                            sClass: 'tal per10',
                            bSortable: false,
                            mData: 'deletado_por',
                        }
                    ],

                    oLanguage: {
                        sSearch: '',
                        sLengthMenu: '<span>_MENU_</span>',
                        sProcessing: 'Processando...',
                        sZeroRecords: 'Não foram encontrados resultados',
                        sInfo: 'Mostrando de _START_ até _END_ de _TOTAL_ registros',
                        sInfoEmpty: 'Mostrando de 0 até 0 de 0 registros',
                        sInfoFiltered: '(filtrado de _MAX_ registros no total)',
                        sInfoPostFix: '',
                        sUrl: '',
                        oPaginate: {
                            sFirst: 'Primeiro',
                            sPrevious: 'Anterior',
                            sNext: 'Seguinte',
                            sLast: 'Último'
                        }
                    },
                    aaSorting: [],
                    // sDom: "T<'row'<'col-md-6 col-xs-12 'l><'col-md-6 col-xs-12'f>r>t<'row'<'col-md-4 col-xs-12'i><'col-md-8 col-xs-12'p>>",
                    sDom: "T",
                    tableTools: {
                        sSwfPath: 'http://cdn.datatables.net/tabletools/2.2.2/swf/copy_csv_xls_pdf.swf',
                        aButtons: []
                    }
                });

                // Atualiza um registro por AJAX
                $(document).on('click', '.obs_submit', function() {
                    var user = '<?php echo $_SESSION['admin_nome']; ?>';
                    var data = {
                        action: $(this).data('action'),
                        id: $(this).data('id'),
                        id_pedido: <?php echo $this->registro['id']; ?>
                    };

                    // Impede a criação de um novo registro sem texto ou categoria
                    if (data.action == 'new') {
                        var categoria = $(this).closest('tr').find('select').val();
                        var texto = $(this).closest('tr').find('textarea').val();
                        if ((!categoria || !texto)) return;
                        data.categoria = categoria;
                        data.texto = texto;
                        data.criado_por = user;
                    } else if (data.action == 'del') {
                        data.deletado_por = user;
                    }

                    $.post(`${pagina}/obs`, data, function(result) {
                        obsTable.fnDraw();
                    });
                });

                //FUNÇÕES PRODUÇÃO
                $("form[name=producao]").clickform({"validateUrl": enviarProducao, 'submitButton': '.clickformProducao', 'blockScroll': false, 'activateEnterKey' : false, 'clearFields': false}, function (data) {
                    if (data.type == "success") {
                        window.location.href = retorno;
                    }
                    continuar = false;
                });
                $('.clickformProducao_').click(function(){
                    continuar = false;
                    $('.clickformProducao').trigger('click');
                });

                $('body').on('click', 'button.mudar_remessa', function (e) {
                    $('.id_ordem').val($(e.target).data('id'));
                    $('.id_ordem_select').val($(e.target).data('id'));
                    $('.select_remessa').val($(e.target).data('remessa'));
                    $('.id_remessa_old_select').val($(e.target).data('remessa'));
                    $('.id_remessa_old').val($(e.target).data('remessa'));
                    $('#modal-mudar-remessa').modal('show');
                });
                $("form[name=criar_mudar_remessa]").clickform({"validateUrl": criarMudarRemessa, 'submitButton': '.clickformcriarMudarRemessa', 'blockScroll': false, 'activateEnterKey' : false, 'clearFields': false}, function (data) {
                    if (data.type == "success") {
                        window.location.reload();
                    }
                    continuar = false;
                });
                $('.clickformcriarMudarRemessa_').click(function(){
                    continuar = false;
                    $('.clickformcriarMudarRemessa').trigger('click');
                });

                $("form[name=mudar_remessa_select]").clickform({"validateUrl": mudarRemessa, 'submitButton': '.clickformMudarRemessaSelect', 'blockScroll': false, 'activateEnterKey' : false, 'clearFields': false}, function (data) {
                    if (data.type == "success") {
                        window.location.reload();
                    }
                    continuar = false;
                });
                $('.clickformMudarRemessaSelect_').click(function(){
                    continuar = false;
                    $('.clickformMudarRemessaSelect').trigger('click');
                });
            });

            function carregar_cidades(id) {
                $(`#${id}-estado`).change(function () {
                    if ($(this).val() != "") {
                        var id_estado = $(this).find("option:selected").val();
                        
                        var cidade = $(this).data('auto-select-cidade');
                        $(`#${id}-cidade`).load("client/cidades/?id=" + id_estado, function() {
                            // Seleciona automaticamente uma, caso esteja marcada no estado
                            $(`#${id}-cidade option[data-cidade="${cidade}"]`).prop('selected', true);
                            $(`#${id}-cidade option[value="${cidade}"]`).prop('selected', true);
                            $(`#${id}-estado`).removeData('auto-select-cidade');
                        });
                    }
                });

                $(`#${id}-estado`).trigger("change");

                // Seleciona automaticamente um estado, se registrado
                if (id_estado = $(`#${id}-estado`).data('auto-select-estado')) {
                    $(`#${id}-estado`).val(id_estado).change();
                }
            }

            function preencherEndereco(id) {
                console.log(`#${id}-cep`);
                cep = limpaCep($(`#${id}-cep`).val());
                
                if (cep.length == 8) {
                    $.get('https://viacep.com.br/ws/' + cep + '/json/', function (resultadoCEP) {
                        if (!("erro" in resultadoCEP)) {
                            $(`#${id}-endereco`).val(resultadoCEP.logradouro);
                            $(`#${id}-bairro`).val(resultadoCEP.bairro);
                            $(`#${id}-estado option`).each(function () {
                                if ($(this).attr("data-uf") == resultadoCEP.uf) {
                                    $(this).prop("selected", true);
                                    $(`#${id}-estado`).attr('data-auto-select-cidade', resultadoCEP.localidade);
                                    $(`#${id}-estado`).trigger("change");
                                }
                            });
                        }else{
                            alert('Esse CEP não foi localizado em nossa base, por favor confira se o mesmo está correto.');
                        }
                    });
                }
            }

            function limpaCep(cep) {
                cep = cep.replace(/[^0-9.]/g, '');
                cep = cep.replace('.', '');
                return cep;
            }
        </script>
    </body>
</html>
